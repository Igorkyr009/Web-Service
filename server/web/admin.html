<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Адмінка</title>
<style>
  :root{--bg:#0b0c10;--card:#111318;--muted:#9aa3af;--text:#f5f7fa;--accent:#0ea5e9;--border:#1f2430}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:rgba(11,12,16,.8);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#151822;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.danger{background:#ef4444;border-color:#ef4444}
  input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#0f1218;color:#fff}
  label{font-size:14px;color:#c9d2de}
  .grid{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .muted{color:var(--muted);font-size:14px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
  .tabs{display:flex;gap:8px;padding:8px 16px;border-bottom:1px solid var(--border)}
  .tabs .btn.active{background:#1b2130}
  .hidden{display:none}
  img.thumb{width:100%;border-radius:12px;aspect-ratio:1/1;object-fit:cover;background:#0f1218}
</style>
<body>
<header>
  <div class="wrap row">
    <h3>Адмінка</h3>
    <div class="row" style="gap:8px">
      <input id="secret" placeholder="Admin Secret (X-Admin-Secret)" style="width:280px">
      <button class="btn primary" onclick="saveSecret()">Зберегти ключ</button>
    </div>
  </div>
  <div class="tabs">
    <div class="wrap" style="display:flex;gap:8px">
      <button class="btn tab active" data-view="products">Товари</button>
      <button class="btn tab" data-view="orders">Замовлення</button>
    </div>
  </div>
</header>

<div id="view-products" class="wrap">
  <div class="grid">
    <div class="card">
      <h4>Товар</h4>
      <div style="display:grid;gap:10px;margin-top:8px">
        <div>
          <label>SKU (унікальний)</label>
          <input id="sku">
        </div>
        <div>
          <label>Назва</label>
          <input id="title">
        </div>
        <div>
          <label>Опис</label>
          <textarea id="description" rows="5"></textarea>
        </div>
        <div class="row" style="gap:10px">
          <div style="flex:1">
            <label>Ціна</label>
            <input id="price" type="number" min="0" value="0">
          </div>
          <div style="flex:1">
            <label>Валюта</label>
            <input id="currency" value="UAH">
          </div>
        </div>
        <div class="row" style="gap:10px">
          <div style="flex:1">
            <label>Категорія</label>
            <select id="category">
              <option value="devices">Девайси</option>
              <option value="liquids">Рідини</option>
              <option value="cartridges">Картриджі</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Доступність</label>
            <select id="availability">
              <option value="in_stock">В наявності</option>
              <option value="preorder">Передзамовлення</option>
            </select>
          </div>
        </div>
        <div>
          <label>Зображення (URL)</label>
          <input id="image_url" placeholder="/uploads/xxx.jpg або https://...">
        </div>
        <div>
          <label>Завантажити зображення (файл)</label>
          <input id="file" type="file" accept="image/*" onchange="uploadFile(this.files[0])">
          <div class="muted">HEIC/HEIF не підтримується — збережіть як JPEG/PNG/WebP.</div>
        </div>
        <div>
          <label><input type="checkbox" id="is_active" checked> Показувати в каталозі</label>
        </div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button class="btn danger" onclick="removeProduct()">Видалити</button>
          <button class="btn primary" onclick="saveProduct()">Зберегти</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="row"><h4>Перелік товарів</h4><button class="btn" onclick="loadProducts()">Оновити</button></div>
      <div id="list" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<div id="view-orders" class="wrap hidden">
  <div class="card">
    <div class="row"><h4>Замовлення</h4><button class="btn" onclick="loadOrders()">Оновити</button></div>
    <div id="orders"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const API = {
  list:  ()=> fetch('/api/admin/catalog', {headers:sec()}).then(r=>r.json()),
  save:  (payload)=> fetch('/api/admin/catalog', {method:'POST',headers:hd(),body:JSON.stringify(payload)}).then(r=>r.json()),
  del:   (sku)=> fetch('/api/admin/catalog/'+encodeURIComponent(sku), {method:'DELETE',headers:sec()}).then(r=>r.json()),
  upl:   (file)=>{
    const fd = new FormData(); fd.append('file', file);
    return fetch('/api/admin/upload', {method:'POST',headers:sec(),body:fd}).then(r=>r.json());
  },
  orders: ()=> fetch('/api/admin/orders', {headers:sec()}).then(r=>r.json()),
  order:  (id)=> fetch('/api/admin/orders/'+id, {headers:sec()}).then(r=>r.json()),
  setStatus:(id, status)=> fetch('/api/admin/orders/'+id+'/status', {method:'POST',headers:hd(),body:JSON.stringify({status})}).then(r=>r.json())
};

function sec(){
  const k = localStorage.getItem('admin_secret')||'';
  return {'X-Admin-Secret': k};
}
function hd(){
  return Object.assign({'Content-Type':'application/json'}, sec());
}

function saveSecret(){
  const v = $('#secret').value.trim();
  if (!v) return alert('Введіть ключ');
  localStorage.setItem('admin_secret', v);
  alert('Збережено');
}

function pick(p){
  $('#sku').value = p.sku||'';
  $('#title').value = p.title||'';
  $('#description').value = p.description||'';
  $('#price').value = p.price||0;
  $('#currency').value = p.currency||'UAH';
  $('#category').value = p.category||'devices';
  $('#availability').value = p.availability||'in_stock';
  $('#image_url').value = p.image_url||'';
  $('#is_active').checked = !!p.is_active;
}

async function loadProducts(){
  const data = await API.list();
  const items = data.items||[];
  const box = $('#list');
  if (!items.length){ box.innerHTML = '<div class="muted">Порожньо</div>'; return; }
  box.innerHTML = items.map(p=>`
    <div class="row" style="gap:12px;border-bottom:1px solid var(--border);padding:10px 0">
      <img class="thumb" src="${p.image_url||'https://picsum.photos/seed/'+encodeURIComponent(p.sku)+'/300/300'}" style="width:68px">
      <div style="flex:1">
        <b>${p.title}</b>
        <div class="muted">${p.sku} • ${p.category} • ${p.availability} • ${p.is_active?'active':'hidden'}</div>
      </div>
      <div class="muted">${p.price} ${p.currency||'UAH'}</div>
      <button class="btn" onclick='pick(${JSON.stringify(p)})'>Редагувати</button>
    </div>
  `).join('');
}

async function saveProduct(){
  const payload = {
    sku: $('#sku').value.trim(),
    title: $('#title').value.trim(),
    description: $('#description').value.trim(),
    price: +($('#price').value||0),
    currency: $('#currency').value.trim() || 'UAH',
    category: $('#category').value,
    availability: $('#availability').value,
    image_url: $('#image_url').value.trim(),
    is_active: $('#is_active').checked ? 1 : 0
  };
  if (!payload.sku) return alert('Вкажіть SKU');
  if (!payload.title) return alert('Вкажіть назву');
  await API.save(payload);
  await loadProducts();
  alert('Збережено');
}

async function removeProduct(){
  const sku = $('#sku').value.trim();
  if (!sku) return alert('Немає SKU');
  if (!confirm('Видалити товар?')) return;
  await API.del(sku);
  await loadProducts();
  alert('Видалено');
}

async function uploadFile(file){
  if (!file) return;
  const res = await API.upl(file);
  if (!res.ok) { alert(res.error||'Помилка'); return; }
  $('#image_url').value = res.url;
  alert('Зображення завантажено');
}

function switchTab(to){
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelector('.tab[data-view="'+to+'"]').classList.add('active');
  document.querySelectorAll('[id^="view-"]').forEach(v=>v.classList.add('hidden'));
  $('#view-'+to).classList.remove('hidden');
}

async function loadOrders(){
  const data = await API.orders();
  const arr = data.orders||[];
  const box = $('#orders');
  if (!arr.length){ box.innerHTML = '<div class="muted">Замовлень поки немає</div>'; return; }
  box.innerHTML = arr.map(o=>`
    <div class="card" style="margin:8px 0">
      <div class="row">
        <div><b>#${o.id}</b> • ${o.total} ${o.currency} • <span class="muted">${o.status}</span></div>
        <button class="btn" onclick="openOrder(${o.id})">Деталі</button>
      </div>
      <div class="muted">${o.tg_username||'-'} • ${o.tg_name||'-'} • ${o.city||'-'} / ${o.branch||'-'}</div>
    </div>
  `).join('');
}

async function openOrder(id){
  const o = await API.order(id);
  const items = (o.items||[]).map(i=>`<li>${i.title} × ${i.qty} = ${i.price*i.qty} ${o.currency}</li>`).join('');
  const st = prompt(
    `Замовлення #${o.id}\n`+
    `Клієнт: ${o.receiver||'-'} / ${o.phone||'-'}\n`+
    `TG: ${o.tg_username||'-'}\n`+
    `Адреса: ${o.city||'-'}, ${o.branch||'-'}\n\n`+
    `Товари:\n - ${items.replace(/<li>|<\/li>/g,'')}\n\n`+
    `Статус: ${o.status}\n\nВведіть новий статус (new|processing|shipped|done|canceled) або залиште як є`,
    o.status
  );
  if (st && st!==o.status){
    await API.setStatus(id, st);
    await loadOrders();
    alert('Статус оновлено');
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  $('#secret').value = localStorage.getItem('admin_secret')||'';
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click', ()=> switchTab(b.dataset.view));
  });
  loadProducts();
});
</script>
</body>
</html>






   



















