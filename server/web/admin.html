<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ê–¥–º—ñ–Ω–∫–∞</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#fafafa; --fg:#0f172a; --muted:#64748b; --line:#e5e7eb; --brand:#0ea5e9;
    --radius:12px; --maxw:980px; --safe-top: env(safe-area-inset-top, 0px);
  }
  html,body{height:100%}
  body{
    margin:0 auto; max-width:var(--maxw); background:var(--bg); color:var(--fg);
    font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    padding:calc(12px + var(--safe-top)) 12px 96px; /* –Ω–∏–∑ –ø–æ–¥ —Ñ–∏–∫—Å-–±–∞—Ä –∫–Ω–æ–ø–∫–∏ */
  }
  h1,h2,h3{margin:0 0 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0 12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px}
  button{padding:10px 14px;border-radius:var(--radius);border:1px solid var(--brand);background:var(--brand);color:#fff;cursor:pointer}
  .ghost{background:#fff;color:var(--brand)}
  .muted{color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:var(--radius);background:#fff}
  label{display:block;font-weight:600;margin-bottom:6px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .form-col{display:grid;gap:12px}
  .two-cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center}
  .preview{width:200px;height:200px;border-radius:12px;border:1px solid var(--line);object-fit:cover;background:#f3f4f6}
  .error{margin:12px 0;padding:10px;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:12px}
  .ok{margin:12px 0;padding:10px;border:1px solid #bbf7d0;background:#f0fdf4;color:#14532d;border-radius:12px}
  .fixedbar{
    position:fixed; left:0; right:0; bottom:0; padding:12px;
    background:rgba(250,250,250,.96); border-top:1px solid var(--line);
    display:flex; justify-content:center; z-index:99;
  }
  .fixedbar > div{width:min(980px,100%); display:flex; justify-content:flex-end; gap:8px}
  @media (max-width:760px){ .form-grid{grid-template-columns:1fr} .row{grid-template-columns:1fr} }
</style>
<body>
  <h2>–ê–¥–º—ñ–Ω–∫–∞</h2>

  <!-- –ü–∞–Ω–µ–ª—å: –∫–ª—é—á, –ø–æ–∏—Å–∫, –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="toolbar">
    <input id="adminKey" placeholder="üîí Admin Secret" style="flex:1;border-color:#e5e7eb">
    <button id="saveKey" class="ghost">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∫–ª—é—á</button>
    <button id="btnCreate" class="ghost">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–æ–≤–∞—Ä</button>
    <input id="search" placeholder="–ü–æ—à—É–∫ –ø–æ SKU/–Ω–∞–∑–≤—ñ" style="flex:1;border-color:#e5e7eb">
    <button id="btnReload" class="ghost">–û–Ω–æ–≤–∏—Ç–∏</button>
    <a href="/index.html#%2Fcatalog" target="_blank"
       class="ghost" style="text-decoration:none;padding:10px 14px;border:1px solid #e5e7eb;border-radius:12px">‚Üí –í—ñ—Ç—Ä–∏–Ω–∞</a>
  </div>

  <div id="msg"></div>

  <div class="card">
    <!-- –≤—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–∞ -->
    <div class="row">
      <div><label for="sku">–¢–æ–≤–∞—Ä (SKU)</label></div>
      <select id="sku"></select>
    </div>

    <div class="form-grid" style="margin-top:8px">
      <div class="form-col">
        <div>
          <label for="title">–ù–∞–∑–≤–∞</label>
          <input id="title" placeholder="–ù–∞–ø—Ä.: –î–µ–≤–∞–π—Å X200">
        </div>
        <div>
          <label for="description">–û–ø–∏—Å</label>
          <textarea id="description" rows="4" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Ç–æ–≤–∞—Ä—É"></textarea>
        </div>
        <div class="two-cols">
          <div>
            <label for="price">–¶—ñ–Ω–∞ (UAH)</label>
            <input id="price" type="number" min="0" step="1" placeholder="0">
          </div>
          <div>
            <label for="category">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <input id="category" placeholder="devises / liquids / cartridges">
          </div>
        </div>
        <div class="two-cols">
          <div>
            <label for="availability">–°—Ç–∞—Ç—É—Å</label>
            <select id="availability">
              <option value="in_stock">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</option>
              <option value="preorder">–ü—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</option>
            </select>
          </div>
          <div>
            <label for="is_active">–ê–∫—Ç–∏–≤–Ω–∏–π</label>
            <select id="is_active">
              <option value="1">–¢–∞–∫</option>
              <option value="0">–ù—ñ</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-col">
        <div>
          <label>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∑ –≥–∞–ª–µ—Ä–µ—ó)</label>
          <img id="preview" class="preview" alt="">
        </div>
        <div>
          <input id="file" type="file" accept="image/*">
          <div class="muted">–§–∞–π–ª –æ–±—Ä—ñ–∑–∞—î—Ç—å—Å—è –¥–æ –∫–≤–∞–¥—Ä–∞—Ç—É 800√ó800 (JPEG) –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.</div>
        </div>
        <div>
          <label for="image_url">image_url</label>
          <input id="image_url" readonly>
        </div>
      </div>
    </div>
  </div>

  <!-- —Ñ–∏–∫—Å-–±–∞—Ä —Å –∫–Ω–æ–ø–∫–æ–π –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
  <div class="fixedbar">
    <div>
      <button id="save" style="min-width:160px">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>

<script>
/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const S = id => document.getElementById(id);
const LS_KEY = 'tgshop.admin.key';
let LIST = [];

function setMsg(html, ok=false){
  const box = $('#msg'); if(!html){ box.innerHTML=''; return; }
  box.innerHTML = `<div class="${ok?'ok':'error'}">${html}</div>`;
  setTimeout(()=>{ box.innerHTML=''; }, 3500);
}
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

function getKey(){ return (S('adminKey').value || '').trim(); }
function saveKeyLocal(){ localStorage.setItem(LS_KEY, getKey()); }
function loadKeyLocal(){ const v = localStorage.getItem(LS_KEY)||''; S('adminKey').value = v; return v; }

function authHeaders(){
  const k = getKey();
  const h = {};
  if(k) h['X-Admin-Secret'] = k;
  return h;
}
function withKeyQuery(url){
  const k = getKey();
  if(!k) return url;
  return url + (url.includes('?') ? '&' : '?') + 'key=' + encodeURIComponent(k);
}
function sortProducts(a){
  return a.slice().sort((x,y)=> (x.category||'').localeCompare(y.category||'') || (x.title||'').localeCompare(y.title||''));
}
function fillSelect(){
  const sel = S('sku');
  sel.innerHTML = LIST.map(p=>`<option value="${p.sku}">${p.sku} ‚Äî ${esc(p.title||'')}</option>`).join('');
}

/* ===== API ===== */
async function apiGet(url){
  const r = await fetch(withKeyQuery(url), {headers: authHeaders()});
  if(!r.ok){
    const t = await r.text();
    throw new Error(`GET ${url} ‚Üí ${r.status}: ${t}`);
  }
  return r.json();
}
async function apiPut(url, body){
  const r = await fetch(withKeyQuery(url), {method:'PUT', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(body)});
  if(!r.ok){
    const t = await r.text();
    throw new Error(`PUT ${url} ‚Üí ${r.status}: ${t}`);
  }
  return r.json();
}
async function apiUpload(file){
  const fd = new FormData(); fd.append('file', file, file.name);
  const r = await fetch(withKeyQuery('/api/upload'), {method:'POST', headers:{...authHeaders()}, body: fd});
  if(!r.ok){
    const t = await r.text();
    throw new Error(`UPLOAD ‚Üí ${r.status}: ${t}`);
  }
  return r.json();
}

/* ===== data flow ===== */
async function loadProducts(q=""){
  try{
    setMsg('');
    const j = await apiGet('/api/products'+(q?`?q=${encodeURIComponent(q)}`:''));
    LIST = sortProducts(j.items||[]);
    if(!LIST.length){
      setMsg('–°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä –∫–ª—é—á –∞–±–æ –¥–æ–¥–∞–π —Ç–æ–≤–∞—Ä.', true);
    }
    fillSelect();
    if(LIST.length) fillForm(LIST[0]);
  }catch(e){
    setMsg('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–æ–≤–∞—Ä–∏. ' + esc(e.message));
    LIST = []; fillSelect();
  }
}
function fillForm(p){
  if(!p){ // –µ—Å–ª–∏ —Å–ø–∏—Å–∫–∞ –Ω–µ—Ç ‚Äî –æ—á–∏—Å—Ç–∏–º –ø–æ–ª—è
    S('title').value = '';
    S('description').value = '';
    S('price').value = 0;
    S('category').value = '';
    S('availability').value = 'in_stock';
    S('is_active').value = 0;
    S('image_url').value = '';
    S('preview').src = 'https://via.placeholder.com/800?text=No+Image';
    return;
  }
  S('sku').value = p.sku;
  S('title').value = p.title || '';
  S('description').value = p.description || '';
  S('price').value = p.price ?? 0;
  S('category').value = p.category || '';
  S('availability').value = p.availability || 'in_stock';
  S('is_active').value = p.is_active ? 1 : 0;
  S('image_url').value = p.image_url || '';
  S('preview').src = p.image_url || 'https://via.placeholder.com/800?text=No+Image';
}

/* ===== events ===== */
S('saveKey').onclick = async ()=>{
  saveKeyLocal();
  await loadProducts($('#search').value.trim());
  setMsg('–ö–ª—é—á –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ', true);
};

S('sku').addEventListener('change', ()=>{
  const sku = S('sku').value;
  const p = LIST.find(x=>x.sku===sku);
  fillForm(p);
});

S('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const res = await apiUpload(f);
    if(!res.ok) throw new Error(res.error||'upload failed');
    S('image_url').value = res.url;
    S('preview').src = res.url;
    setMsg('–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', true);
  }catch(err){
    setMsg('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: '+esc(err.message));
  }finally{
    e.target.value = '';
  }
});

S('save').addEventListener('click', async ()=>{
  const sku = S('sku').value.trim();
  if(!sku){ setMsg('SKU –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
  const body = {
    title: S('title').value.trim(),
    description: S('description').value.trim(),
    price: parseInt(S('price').value||'0',10),
    category: S('category').value.trim(),
    availability: S('availability').value,
    is_active: parseInt(S('is_active').value,10),
    image_url: S('image_url').value.trim(),
    currency: "UAH"
  };
  try{
    const j = await apiPut(`/api/products/${encodeURIComponent(sku)}`, body);
    if(!j.ok) throw new Error(j.error||'save failed');
    // –ª–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–º, —á—Ç–æ–±—ã —Å–µ–ª–µ–∫—Ç/—Ñ–æ—Ä–º–∞ –Ω–µ ¬´–ø—Ä—ã–≥–∞–ª–∏¬ª
    const i = LIST.findIndex(x=>x.sku===sku);
    if(i>=0) LIST[i] = {...LIST[i], ...body}; else LIST.push({sku, ...body});
    LIST = sortProducts(LIST);
    fillSelect(); S('sku').value = sku;
    setMsg('–ó–±–µ—Ä–µ–∂–µ–Ω–æ', true);
  }catch(e){
    setMsg('–ù–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ: '+esc(e.message));
  }
});

$('#btnReload').onclick = ()=> loadProducts($('#search').value.trim());
$('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#btnReload').click(); });

$('#btnCreate').onclick = async ()=>{
  const sku = prompt('SKU –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É:'); if(!sku) return;
  try{
    const draft = {title: sku, price: 0, currency: "UAH", is_active: 0, availability: "in_stock"};
    const j = await apiPut(`/api/products/${encodeURIComponent(sku)}`, draft);
    if(!j.ok) throw new Error(j.error||'create failed');
    await loadProducts($('#search').value.trim());
    S('sku').value = sku;
    const p = LIST.find(x=>x.sku===sku); fillForm(p);
    setMsg('–°—Ç–≤–æ—Ä–µ–Ω–æ —á–µ—Ä–Ω–µ—Ç–∫—É', true);
  }catch(e){
    setMsg('–ù–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ: '+esc(e.message));
  }
};

/* —Å—Ç–∞—Ä—Ç */
loadKeyLocal();
loadProducts();
</script>
</body>
</html>





   

















