<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–∞–≥–∞–∑–∏–Ω</title>
<style>
  :root{
    --bg:#0b0c10; --card:#111318; --muted:#9aa3af; --text:#f5f7fa;
    --accent:#0ea5e9; --accent-2:#22c55e; --danger:#ef4444;
    --border:#1f2430;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:rgba(11,12,16,.8);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  h1,h2,h3{margin:0}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#151822;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.success{background:var(--accent-2);border-color:var(--accent-2);color:#06120a}
  .btn.ghost{background:transparent}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .card img{width:100%;border-radius:12px;aspect-ratio:1/1;object-fit:cover;background:#0f1218}
  .muted{color:var(--muted);font-size:14px}
  .price-row{display:flex;justify-content:space-between;align-items:center;margin-top:2px}
  .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#161a22;color:#b7c0cc}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs .btn.active{background:#1b2130}
  .hidden{display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
  .modal .box{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:560px;width:100%;padding:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .form{display:grid;gap:10px}
  input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#0f1218;color:var(--text)}
  label{font-size:14px;color:#c9d2de}
  .agree{display:flex;gap:10px;align-items:flex-start}
  .catbar{padding:8px 16px;border-bottom:1px solid var(--border)}
  .success{padding:40px 16px;text-align:center}
</style>
<body>

<header>
  <div class="wrap row">
    <h3>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h3>
    <div class="row" style="gap:8px">
      <button id="btnCart" class="btn">üß∫ –ö–æ—à–∏–∫ (<span id="cnt">0</span>)</button>
      <button id="btnBuy" class="btn primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </div>
  <div class="catbar">
    <div class="wrap tabs">
      <button class="btn ghost tab" data-cat="all">–£—Å—ñ</button>
      <button class="btn ghost tab" data-cat="devices">–î–µ–≤–∞–π—Å–∏</button>
      <button class="btn ghost tab" data-cat="liquids">–†—ñ–¥–∏–Ω–∏</button>
      <button class="btn ghost tab" data-cat="cartridges">–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ</button>
    </div>
  </div>
</header>

<div id="view-catalog" class="wrap">
  <div id="grid" class="grid"></div>
</div>

<div id="view-product" class="wrap hidden">
  <button class="btn ghost" onclick="go('#/catalog')">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="prod"></div>
</div>

<div id="view-checkout" class="wrap hidden">
  <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
  <div class="form" style="margin-top:12px">
    <div class="row" style="gap:12px">
      <div style="flex:1">
        <label>–ú—ñ—Å—Ç–æ</label>
        <input id="city" placeholder="–ö–∏—ó–≤">
      </div>
      <div style="flex:1">
        <label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
        <input id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ25">
      </div>
    </div>
    <div class="row" style="gap:12px">
      <div style="flex:1">
        <label>–ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</label>
        <input id="receiver" placeholder="–Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤">
      </div>
      <div style="flex:1">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input id="phone" placeholder="+380..." inputmode="tel">
      </div>
    </div>
    <div>
      <label>–í–∞—à –Ω—ñ–∫ —É Telegram (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –∑ @)</label>
      <input id="username" placeholder="@username">
    </div>
    <div class="agree">
      <input type="checkbox" id="agree18">
      <label for="agree18">–ú–µ–Ω—ñ –≤–∏–ø–æ–≤–Ω–∏–ª–æ—Å—è 18 —Ä–æ–∫—ñ–≤.</label>
    </div>
    <div class="agree">
      <input type="checkbox" id="acceptRules">
      <label for="acceptRules">–ü–æ–≥–æ–¥–∂—É—é—Å—å –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –º–∞–≥–∞–∑–∏–Ω—É.</label>
    </div>
    <div class="row" style="justify-content:space-between">
      <div class="muted">–ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –º–∏ –∑–≤'—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ –≤ Telegram.</div>
      <button id="btnSubmit" class="btn success">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    </div>
  </div>
</div>

<div id="view-success" class="wrap hidden">
  <div class="success">
    <h2>‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ</h2>
    <p class="muted">–î—è–∫—É—î–º–æ! –ú–∏ —Å–∫–æ—Ä–æ –∑–≤'—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ —â–æ–¥–æ –¥–æ—Å—Ç–∞–≤–∫–∏.</p>
    <button class="btn" onclick="go('#/catalog')">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</button>
  </div>
</div>

<!-- –ö–æ—à–∏–∫ -->
<div id="modal" class="modal">
  <div class="box">
    <div class="row"><h3>–ö–æ—à–∏–∫</h3><button class="btn" onclick="closeCart()">‚úï</button></div>
    <div id="cartBody" style="margin-top:12px"></div>
    <div class="row" style="margin-top:12px">
      <div><b>–í—Å—å–æ–≥–æ:</b> <span id="sum">0</span> <span id="cur">UAH</span></div>
      <div>
        <button class="btn" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button class="btn primary" onclick="go('#/checkout');closeCart()">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- First-run 18+ popup -->
<div id="consent" class="modal">
  <div class="box">
    <h3>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
    <p class="muted">–©–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏, –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å, —â–æ –≤–∞–º 18+ —ñ –≤–∏ –ø—Ä–∏–π–º–∞—î—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –º–∞–≥–∞–∑–∏–Ω—É.</p>
    <div class="agree"><input id="c18" type="checkbox"><label for="c18">–ú–µ–Ω—ñ 18+</label></div>
    <div class="agree"><input id="cru" type="checkbox"><label for="cru">–ü—Ä–∏–π–º–∞—é –ø—Ä–∞–≤–∏–ª–∞</label></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn primary" onclick="confirmConsent()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const cartKey = 'cart_v1';
let cart = {}; // { sku: qty }
let catalog = []; // —Å —Å–µ—Ä–≤–µ—Ä–∞
let currentCat = 'all';

function saveCart(){ localStorage.setItem(cartKey, JSON.stringify(cart)); renderCount(); }
function loadCart(){ try{ cart = JSON.parse(localStorage.getItem(cartKey) || '{}'); }catch(e){ cart = {}; } }
function renderCount(){ $('#cnt').textContent = Object.values(cart).reduce((a,b)=>a+b,0); }

function fmt(p,c){ return `${p} ${c||'UAH'}`; }

function go(hash){ location.hash = hash; }

function setView(id){
  for (const v of ['view-catalog','view-product','view-checkout','view-success']) {
    $('#'+v).classList.add('hidden');
  }
  $(id).classList.remove('hidden');
}

function openCart(){
  renderCart();
  $('#modal').style.display = 'flex';
}
function closeCart(){ $('#modal').style.display = 'none'; }

function renderCart(){
  const body = $('#cartBody');
  if (!Object.keys(cart).length){ body.innerHTML = '<div class="muted">–ü–æ—Ä–æ–∂–Ω—å–æ</div>'; $('#sum').textContent='0'; return; }
  let html = '<table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö-—Å—Ç—å</th><th>–¶—ñ–Ω–∞</th><th></th></tr></thead><tbody>';
  let sum = 0, currency = 'UAH';
  for (const [sku, qty] of Object.entries(cart)){
    const p = catalog.find(x=>x.sku===sku);
    if (!p) continue;
    sum += p.price * qty; currency = p.currency || currency;
    html += `<tr>
      <td>${p.title}</td>
      <td>
        <button class="btn" onclick="dec('${sku}')">‚àí</button>
        <b style="padding:0 8px">${qty}</b>
        <button class="btn" onclick="inc('${sku}')">+</button>
      </td>
      <td>${fmt(p.price*qty,p.currency)}</td>
      <td><button class="btn" onclick="del('${sku}')">üóë</button></td>
    </tr>`;
  }
  html += '</tbody></table>';
  body.innerHTML = html;
  $('#sum').textContent = sum; $('#cur').textContent = currency;
}

function inc(sku){ cart[sku]=(cart[sku]||0)+1; saveCart(); renderCart(); }
function dec(sku){ if(!cart[sku]) return; cart[sku]-=1; if(cart[sku]<=0) delete cart[sku]; saveCart(); renderCart(); }
function del(sku){ delete cart[sku]; saveCart(); renderCart(); }
function clearCart(){ cart={}; saveCart(); renderCart(); }

function productCard(p){
  const chip = p.availability==='preorder' ? '<span class="chip">–ü–µ—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>' : '<span class="chip">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>';
  const img = p.image_url || 'https://picsum.photos/seed/' + encodeURIComponent(p.sku) + '/600/600';
  return `<div class="card">
    <img src="${img}" alt="">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div><b>${p.title}</b><div class="muted">${chip}</div></div>
      <div class="muted">${fmt(p.price,p.currency)}</div>
    </div>
    <div class="row">
      <button class="btn" onclick="add('${p.sku}')">–î–æ–¥–∞—Ç–∏</button>
      <button class="btn primary" onclick="go('#/p/${encodeURIComponent(p.sku)}')">–î–æ–∫–ª–∞–¥–Ω—ñ—à–µ</button>
    </div>
  </div>`;
}

function add(sku){ cart[sku]=(cart[sku]||0)+1; saveCart(); }

function renderCatalog(){
  const grid = $('#grid');
  let items = catalog.filter(x=>x.is_active);
  if (currentCat!=='all') items = items.filter(x=>x.category===currentCat);
  grid.innerHTML = items.map(productCard).join('');
}

function renderProduct(sku){
  const p = catalog.find(x=>x.sku===sku);
  if (!p){ $('#prod').innerHTML = '<div class="muted">–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  const img = p.image_url || 'https://picsum.photos/seed/' + encodeURIComponent(p.sku) + '/900/900';
  $('#prod').innerHTML = `
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;align-items:start">
      <img src="${img}" style="width:100%;border-radius:16px;aspect-ratio:1/1;object-fit:cover">
      <div>
        <h2>${p.title}</h2>
        <div class="muted" style="margin:4px 0 10px">${p.availability==='preorder'?'–ü–µ—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':'–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</div>
        <div><b style="font-size:20px">${fmt(p.price,p.currency)}</b></div>
        <p class="muted" style="margin:12px 0">${p.description||''}</p>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="add('${p.sku}')">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
          <button class="btn primary" onclick="go('#/checkout')">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
        </div>
      </div>
    </div>`;
}

function wants(hash){ return (location.hash||'#/catalog')===hash; }

function route(){
  const h = (location.hash||'#/catalog');
  if (h.startsWith('#/p/')){
    setView('view-product');
    const sku = decodeURIComponent(h.split('/p/')[1]);
    renderProduct(sku);
  } else if (h==="#/checkout"){
    setView('view-checkout');
    prefillUser();
  } else {
    setView('view-catalog');
    renderCatalog();
  }
}

function prefillUser(){
  const tg = window.Telegram?.WebApp;
  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    const u = tg.initDataUnsafe.user;
    if (u.username) $('#username').value = '@' + u.username;
  }
}

async function loadCatalog(){
  const r = await fetch('/api/catalog');
  const data = await r.json();
  catalog = data.items || [];
  renderCatalog();
}

function hookTabs(){
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      currentCat = b.dataset.cat;
      renderCatalog();
    });
  });
  // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º "–£—Å—ñ" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  document.querySelector('.tab[data-cat="all"]').classList.add('active');
}

function bindHeader(){
  $('#btnCart').onclick = openCart;
  $('#btnBuy').onclick  = ()=> go('#/checkout');
  window.addEventListener('hashchange', route);
}

function sendOrder(){
  if (!Object.keys(cart).length){ alert('–ü–æ—Ä–æ–∂–Ω—è –∫–æ—Ä–∑–∏–Ω–∞'); return; }
  const city = $('#city').value.trim();
  const branch = $('#branch').value.trim();
  const receiver = $('#receiver').value.trim();
  const phone = $('#phone').value.trim();
  const username = $('#username').value.trim();
  const agree18 = $('#agree18').checked;
  const acceptRules = $('#acceptRules').checked;

  if (!username.startsWith('@')){
    alert('–í–∫–∞–∂—ñ—Ç—å –Ω—ñ–∫ —É Telegram (–∑ @)'); return;
  }
  const tg = window.Telegram?.WebApp;
  if (!tg){
    alert('–í—ñ–¥–∫—Ä–∏–π —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ Telegram'); return;
  }
  // —Å–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
  const items = [];
  for (const [sku, qty] of Object.entries(cart)){
    if (qty>0) items.push({sku, qty});
  }
  if (!items.length){ alert('–ü–æ—Ä–æ–∂–Ω—è –∫–æ—Ä–∑–∏–Ω–∞'); return; }

  tg.ready();
  tg.sendData(JSON.stringify({
    type: "checkout",
    items, city, branch, receiver, phone,
    username, agree18, acceptRules
  }));
  tg.showAlert('‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –±–æ—Ç—É');
  // –ø–æ—Å–ª–µ –∞–ª–µ—Ä—Ç–∞ ‚Äî —á–∏—Å—Ç–∏–º –∫–æ—Ä–∑–∏–Ω—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º success
  cart = {}; saveCart();
  go('#/success');
}

function setupCheckout(){
  $('#btnSubmit').onclick = sendOrder;
}

function ensureConsent(){
  const ok = localStorage.getItem('consent_ok');
  if (ok==='1') return;
  $('#consent').style.display = 'flex';
}
function confirmConsent(){
  const a = $('#c18').checked, b = $('#cru').checked;
  if (!a || !b){ alert('–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å 18+ —ñ –ø—Ä–∞–≤–∏–ª–∞'); return; }
  localStorage.setItem('consent_ok', '1');
  $('#consent').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', async ()=>{
  ensureConsent();
  loadCart(); renderCount();
  await loadCatalog();
  hookTabs();
  bindHeader();
  setupCheckout();
  route();
});
</script>
</body>
</html>





















