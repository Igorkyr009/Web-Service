<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω</title>
  <style>
    :root { --primary:#0ea5e9; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0 auto;max-width:960px;padding:16px;background:#0b0f14;color:#e7eef7}
    a{color:inherit}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    h2{margin:0;display:flex;align-items:center;gap:8px}
    .actions{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:10px;border:1px solid #1e293b;background:#111827;color:#e7eef7;cursor:pointer}
    button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    button:disabled{opacity:.5;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{border:1px solid #1f2a37;background:#0f1720;border-radius:14px;padding:12px}
    .card img{width:100%;border-radius:10px;aspect-ratio:3/2;object-fit:cover;background:#0b1220}
    .muted{color:#a3b3c5;min-height:36px;font-size:13px}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .price{font-weight:700}

    /* checkout */
    .checkout{display:grid;gap:12px}
    .items{border:1px solid #1f2a37;background:#0f1720;border-radius:12px;padding:12px}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #1f2a37}
    .item:last-child{border-bottom:0}
    .sum{display:flex;justify-content:space-between;align-items:center;font-weight:700;margin-top:6px}
    .field{display:grid;gap:6px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #1e293b;background:#0b1220;color:#e7eef7}
    .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .hint{color:#8aa0b8;font-size:13px}
  </style>
</head>
<body>

  <header>
    <h2>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h2>
    <div class="actions">
      <button id="btn-cart" type="button">üß∫ –ö–æ—à–∏–∫ (<span id="cart-count">0</span>)</button>
      <button id="btn-checkout" type="button" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </header>

  <main id="app"></main>

  <script>
    // ------- —Å–æ—Å—Ç–æ—è–Ω–∏–µ -------
    let CATALOG = null;           // –∫—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞
    const CART = new Map();       // sku -> qty
    const currency = (p,c) => `${p} ${c||'UAH'}`;

    // ------- —É—Ç–∏–ª–∏—Ç—ã -------
    const $ = sel => document.querySelector(sel);
    const app = $('#app');
    const fmt = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    const cartCountEl = $('#cart-count');

    function cartTotal() {
      let total = 0, curr = 'UAH';
      if (!CATALOG) return { total:0, curr };
      for (const [sku, qty] of CART.entries()) {
        const p = CATALOG.find(x => x.sku === sku);
        if (p) { total += p.price * qty; curr = p.currency || curr; }
      }
      return { total, curr };
    }
    function renderCartCount(){
      let n = 0;
      for (const q of CART.values()) n += q;
      cartCountEl.textContent = n;
    }

    // ------- —ç–∫—Ä–∞–Ω –∫–∞—Ç–∞–ª–æ–≥–∞ -------
    async function showCatalog() {
      // –∑–∞–≥–æ–ª–æ–≤–æ–∫
      $('header h2').textContent = 'üõç –í—ñ—Ç—Ä–∏–Ω–∞';

      if (!CATALOG) {
        const r = await fetch('/api/catalog', {cache:'no-store'});
        const data = await r.json();
        CATALOG = (data.items || []).filter(x => x.is_active);
      }

      const grid = document.createElement('div');
      grid.className = 'grid';

      CATALOG.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${p.image_url || 'https://via.placeholder.com/600x400?text=No+Image'}" alt="">
          <h4>${p.title}</h4>
          <div class="muted">${p.description || ''}</div>
          <div class="row">
            <div class="price">${fmt(p.price)} ${p.currency || 'UAH'}</div>
            <button class="primary" type="button">–î–æ–¥–∞—Ç–∏</button>
          </div>
        `;
        card.querySelector('button').onclick = () => {
          CART.set(p.sku, (CART.get(p.sku) || 0) + 1);
          renderCartCount();
        };
        grid.appendChild(card);
      });

      app.replaceChildren(grid);
    }

    // ------- —ç–∫—Ä–∞–Ω –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -------
    function showCheckout() {
      // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤–µ—Ä–Ω—ë–º –≤ –∫–∞—Ç–∞–ª–æ–≥
      if (CART.size === 0) {
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏.');
        location.hash = 'catalog';
        return;
      }
      $('header h2').textContent = 'üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è';

      const wrap = document.createElement('div');
      wrap.className = 'checkout';

      // —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
      const box = document.createElement('div');
      box.className = 'items';
      for (const [sku, qty] of CART.entries()) {
        const p = CATALOG?.find(x => x.sku === sku);
        if (!p) continue;
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div>${p.title}</div>
          <div>√ó ${qty}</div>
          <div>${fmt(p.price * qty)} ${p.currency || 'UAH'}</div>
        `;
        box.appendChild(row);
      }
      const { total, curr } = cartTotal();
      const sum = document.createElement('div');
      sum.className = 'sum';
      sum.innerHTML = `<span>–í—Å—å–æ–≥–æ</span><span>${fmt(total)} ${curr}</span>`;
      box.appendChild(sum);

      // —Ñ–æ—Ä–º–∞
      const f = document.createElement('div');
      f.innerHTML = `
        <div class="field">
          <label>–ú—ñ—Å—Ç–æ</label>
          <input id="city" placeholder="–ö–∏—ó–≤" />
        </div>
        <div class="field">
          <label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
          <input id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ25" />
        </div>
        <div class="field">
          <label>–û—Ç—Ä–∏–º—É–≤–∞—á</label>
          <input id="receiver" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ" />
        </div>
        <div class="field">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="phone" placeholder="+380..." />
          <div class="hint">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.</div>
        </div>
        <div class="bar">
          <button id="confirm" class="primary" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
      `;

      wrap.appendChild(box);
      wrap.appendChild(f);
      app.replaceChildren(wrap);

      // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
      $('#confirm').onclick = () => {
        const city     = $('#city').value.trim();
        const branch   = $('#branch').value.trim();
        const receiver = $('#receiver').value.trim();
        const phone    = $('#phone').value.trim();

        if (!city || !branch || !receiver || !phone) {
          alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—ñ –ø–æ–ª—è.');
          return;
        }

        const items = Array.from(CART.entries()).map(([sku, qty]) => ({ sku, qty }));
        const payload = {
          type: 'checkout',
          items, city, branch, receiver, phone
        };

        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.sendData(JSON.stringify(payload));
          Telegram.WebApp.close();
        } else {
          // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ Telegram
          alert('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–µ–º–æ):\n' + JSON.stringify(payload, null, 2));
        }
      };
    }

    // ------- —Ä–æ—É—Ç–µ—Ä -------
    function wantsCheckout() {
      const q = new URLSearchParams(location.search);
      return location.hash === '#checkout' || (q.get('view')||'').toLowerCase()==='checkout';
    }
    function renderByHash(){
      const v = (location.hash || (wantsCheckout() ? '#checkout' : '#catalog')).toLowerCase();
      if (v === '#checkout') showCheckout(); else showCatalog();
    }

    document.addEventListener('DOMContentLoaded', () => {
      try { sessionStorage.removeItem('ui_step'); } catch(e){}
      renderByHash();
      renderCartCount();
    });
    window.addEventListener('hashchange', renderByHash);

    // ------- –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ -------
    $('#btn-checkout').addEventListener('click', (e) => {
      e.preventDefault();
      if (CART.size === 0) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏.'); return; }
      location.hash = 'checkout';
    });
    $('#btn-cart').addEventListener('click', (e) => {
      e.preventDefault();
      location.hash = 'catalog';
    });
  </script>
</body>
</html>






