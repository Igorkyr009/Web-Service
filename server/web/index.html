<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–∞–≥–∞–∑–∏–Ω</title>
<style>
  :root{--radius:14px}
  body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0 auto;max-width:950px;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  header h2{margin:0}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{padding:10px 12px;border:1px solid #ddd;border-radius:var(--radius);background:#fff;cursor:pointer}
  .primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  .muted{color:#667085}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:16px}
  .card{border:1px solid #eee;border-radius:var(--radius);padding:12px;background:#fff}
  .card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;background:#f6f6f6}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .catbar{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  a.tab{padding:8px 10px;border-radius:999px;border:1px solid #ddd;text-decoration:none;color:#111}
  a.tab.active{background:#111;color:#fff;border-color:#111}
  .back{margin:8px 0;display:inline-block}
  input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .form .full{grid-column:1 / -1}
  .empty{padding:24px;border:1px dashed #ddd;border-radius:14px;text-align:center;color:#667085}
</style>
<body>
  <header>
    <h2>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h2>
    <div class="toolbar">
      <button id="btnCart">üß∫ –ö–æ—à–∏–∫ (<span id="cartCount">0</span>)</button>
      <button id="btnCheckout" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </header>

  <nav class="catbar">
    <a class="tab" data-cat=""       href="#catalog">–í—Å—ñ</a>
    <a class="tab" data-cat="devises" href="#catalog?cat=devises">–î–µ–≤–∞–π—Å–∏</a>
    <a class="tab" data-cat="liquids" href="#catalog?cat=liquids">–†—ñ–¥–∏–Ω–∏</a>
    <a class="tab" data-cat="cartridges" href="#catalog?cat=cartridges">–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ</a>
  </nav>

  <div id="root"></div>

<script>
  // ===== STATE =====
  const LS_KEY = "tgshop.cart.v1";
  let CART = new Map();          // sku -> qty
  let CATALOG = [];              // products
  let CURRENT_CAT = "";          // category filter

  // ===== UTIL =====
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const fmt = (p,c)=>`${p} ${c||'UAH'}`;
  function isTg(){
    try { return typeof Telegram !== 'undefined' && Telegram.WebApp && typeof Telegram.WebApp.sendData==='function'; }
    catch(e){ return false; }
  }

  // ===== CART PERSIST =====
  function loadCart(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (raw) CART = new Map(JSON.parse(raw));
    }catch(e){}
  }
  function saveCart(){
    try { localStorage.setItem(LS_KEY, JSON.stringify(Array.from(CART.entries()))); } catch(e){}
  }
  function cartCount(){
    let n=0; for(const q of CART.values()) n+=q; return n;
  }
  function updateCount(){ $('#cartCount').textContent = cartCount(); }

  // ===== DATA =====
  async function fetchCatalog(cat=""){
    const q = cat ? `?category=${encodeURIComponent(cat)}` : "";
    const r = await fetch(`/api/catalog${q}`);
    const j = await r.json();
    CATALOG = j.items || [];
  }

  // ===== VIEWS =====
  function setTabs(cat){
    $$('.tab').forEach(t=>{
      t.classList.toggle('active', (t.dataset.cat||'')===cat);
    });
  }

  function showCatalog(cat=""){
    CURRENT_CAT = cat || "";
    setTabs(CURRENT_CAT);

    const root = $('#root');
    if (!CATALOG.length){
      root.innerHTML = `<div class="empty">–ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</div>`;
      return;
    }

    const list = CATALOG.filter(p=>!CURRENT_CAT || (p.category||"")===CURRENT_CAT);
    if (!list.length){
      root.innerHTML = `<div class="empty">–£ —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ</div>`;
      return;
    }

    root.innerHTML = `<div class="grid"></div>`;
    const grid = root.firstElementChild;

    list.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <img src="${p.image_url || 'https://via.placeholder.com/800?text=No+Image'}" alt="">
        <h4>${p.title} ${p.availability==='preorder' ? '<span class="muted">¬∑ –ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>' : ''}</h4>
        <div class="muted">${p.description ? p.description.slice(0,90) : ''}</div>
        <div class="row">
          <b>${fmt(p.price,p.currency)}</b>
          <div>
            <button data-sku="${p.sku}" data-act="add">–î–æ–¥–∞—Ç–∏</button>
            <button data-sku="${p.sku}" data-act="open" class="primary">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</button>
          </div>
        </div>
      `;
      grid.appendChild(el);
    });

    grid.addEventListener('click',(e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const sku = btn.dataset.sku;
      const p = CATALOG.find(x=>x.sku===sku);
      if(!p) return;

      if (btn.dataset.act === 'add'){
        CART.set(sku, (CART.get(sku)||0)+1);
        saveCart(); updateCount();
      } else if (btn.dataset.act === 'open'){
        location.hash = `product/${encodeURIComponent(sku)}`;
      }
    }, {once:true});
  }

  function showProduct(sku){
    const p = CATALOG.find(x=>x.sku===sku);
    const root = $('#root');
    if (!p){
      root.innerHTML = `<div class="empty">–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`;
      return;
    }
    root.innerHTML = `
      <a class="back" href="#catalog${CURRENT_CAT?`?cat=${CURRENT_CAT}`:''}">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è</a>
      <div class="card">
        <div class="row" style="gap:16px;align-items:flex-start">
          <img src="${p.image_url || 'https://via.placeholder.com/800?text=No+Image'}" style="width:300px;max-width:45%;aspect-ratio:1/1;object-fit:cover;border-radius:12px">
          <div style="flex:1">
            <h3 style="margin:0 0 6px">${p.title}</h3>
            <div class="muted" style="margin-bottom:12px">${p.description || ''}</div>
            <div class="muted" style="margin-bottom:12px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <b>${p.category||'‚Äî'}</b></div>
            <div class="muted" style="margin-bottom:12px">–°—Ç–∞—Ç—É—Å: <b>${p.availability==='preorder'?'–ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':'–≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</b></div>
            <div class="row">
              <b style="font-size:18px">${fmt(p.price,p.currency)}</b>
              <div>
                <button id="minus">‚Äì</button>
                <span id="qty" style="display:inline-block;min-width:24px;text-align:center">1</span>
                <button id="plus">+</button>
                <button id="add" class="primary">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    let q = 1;
    const $qty = $('#qty');
    $('#minus').onclick = ()=>{ if(q>1){ q--; $qty.textContent=q; } };
    $('#plus').onclick  = ()=>{ q++; $qty.textContent=q; };
    $('#add').onclick   = ()=>{
      CART.set(sku, (CART.get(sku)||0)+q);
      saveCart(); updateCount();
      alert('–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫');
    };
  }

  function showCheckout(){
    const items = Array.from(CART.entries()).map(([sku,qty])=>{
      const p = CATALOG.find(x=>x.sku===sku);
      return {sku, qty, title: p?.title || sku, price: p?.price || 0, currency: p?.currency || 'UAH'};
    });
    const sum = items.reduce((s,i)=>s+i.price*i.qty,0);

    const root = $('#root');
    root.innerHTML = `
      <a class="back" href="#catalog${CURRENT_CAT?`?cat=${CURRENT_CAT}`:''}">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è</a>
      <div class="card">
        <h3 style="margin-top:0">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</h3>

        ${items.length ? `
          <div style="margin-bottom:10px">
            ${items.map(i=>`
              <div class="row" style="margin:6px 0">
                <div>${i.title}</div>
                <div class="muted">√ó ${i.qty}</div>
                <div><b>${fmt(i.price*i.qty, i.currency)}</b></div>
              </div>
            `).join('')}
            <div class="row" style="border-top:1px dashed #ddd;margin-top:6px;padding-top:8px">
              <div><b>–†–∞–∑–æ–º</b></div>
              <div></div>
              <div><b>${fmt(sum, items[0]?.currency||'UAH')}</b></div>
            </div>
          </div>
        ` : `<div class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`}

        <div class="form">
          <div><label>–ú—ñ—Å—Ç–æ<input id="city" placeholder="–ö–∏—ó–≤"></label></div>
          <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü<input id="branch" placeholder="‚Ññ25"></label></div>
          <div class="full"><label>–ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞<input id="receiver" placeholder="–Ü–º º—è –ü—Ä—ñ–∑–≤–∏—â–µ"></label></div>
          <div><label>–¢–µ–ª–µ—Ñ–æ–Ω<input id="phone" placeholder="+380..."></label></div>
          <div><label>–í–∞—à –Ω—ñ–∫ —É Telegram (–æ–ø—Ü.)<input id="username" placeholder="@nickname"></label></div>
        </div>

        <div class="row" style="margin-top:12px">
          <div></div>
          <button id="confirm" class="primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>
      </div>
    `;

    $('#confirm').onclick = ()=>{
      if (!items.length){ alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
      const city = $('#city').value.trim();
      const branch = $('#branch').value.trim();
      const receiver = $('#receiver').value.trim();
      const phone = $('#phone').value.trim();
      const username = $('#username').value.trim();
      if (!city || !branch || !receiver || !phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'); return; }

      const payload = {type:'checkout', items: items.map(i=>({sku:i.sku,qty:i.qty})),
                       city, branch, receiver, phone, username};

      if (isTg()){
        Telegram.WebApp.ready();
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.close();
      } else {
        alert('–í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ –∫–Ω–æ–ø–∫–∏ —É Telegram.\n\n' + JSON.stringify(payload,null,2));
      }
    };
  }

  // ===== ROUTER =====
  function parseHash(){
    const h = location.hash || "#catalog";
    if (h.startsWith("#catalog")){
      const u = new URL(location.href);
      const cat = (u.hash.split("?")[1]||"").split("=")[1]||"";
      return {view:"catalog", cat: decodeURIComponent(cat||"")};
    }
    if (h.startsWith("#product/")){
      return {view:"product", sku: decodeURIComponent(h.split("/")[1]||"")};
    }
    if (h==="#checkout") return {view:"checkout"};
    return {view:"catalog"};
  }

  async function render(){
    loadCart(); updateCount();
    const r = parseHash();
    await fetchCatalog(""); // —Ä–∞–∑ –∑–∞–≥—Ä—É–∑–∏–º –≤—Å–µ; —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ cat –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    if (r.view==="catalog") showCatalog(r.cat||"");
    else if (r.view==="product") showProduct(r.sku);
    else if (r.view==="checkout") showCheckout();
  }

  window.addEventListener('hashchange', render);
  window.addEventListener('DOMContentLoaded', render);

  // Top buttons
  $('#btnCart').onclick = ()=>{
    const arr = Array.from(CART.entries()).map(([s,q])=>{
      const p = CATALOG.find(x=>x.sku===s);
      return `${p?.title||s} √ó ${q}`;
    });
    alert(arr.join('\n') || '–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π');
  };
  $('#btnCheckout').onclick = ()=>{ location.hash = "checkout"; };
</script>
</body>
</html>












