<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>–ú–∞–≥–∞–∑–∏–Ω</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  body{font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0 auto;max-width:980px;padding:16px;background:#fafafa;color:#0f172a}
  h2,h3,h4{margin:0 0 10px}
  a{color:inherit;text-decoration:none}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:8px}
  .actions{display:flex;gap:8px}
  button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer}
  .primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .muted{color:#64748b}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .tab{padding:8px 12px;border:1px solid #e5e7eb;border-radius:999px}
  .tab.active{background:#111827;border-color:#111827;color:#fff}
  #root{min-height:50vh}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
  .card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;background:#f3f4f6}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .back{display:inline-block;margin:8px 0}

  .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form .full{grid-column:1 / -1}
  input,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .modal.show{display:flex}
  .sheet{width:min(92vw,520px);max-height:80vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid #e5e7eb;padding:14px}
  .list{display:grid;gap:8px;margin:8px 0}
  .empty{padding:24px;border:1px dashed #e5e7eb;background:#fff;border-radius:14px;text-align:center;color:#64748b}

  /* –¢–æ–≤–∞—Ä: –≥–∏–±–∫–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ */
  .product{display:grid;grid-template-columns:340px 1fr;gap:16px}
  .product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;background:#f3f4f6}
  @media (max-width:860px){ .product{grid-template-columns:1fr} }

  /* –û–≤–µ—Ä–ª–µ–π —Å–æ–≥–ª–∞—Å–∏—è (18+ –∏ –ø—Ä–∞–≤–∏–ª–∞) */
  .gate{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .gate.show{display:flex}
  .gate .box{width:min(94vw,640px);background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  .checks{display:grid;gap:8px;margin:12px 0}
  .checks label{display:flex;gap:10px;align-items:flex-start;cursor:pointer}
  .gate .rowend{display:flex;justify-content:flex-end;gap:8px}
  @media (max-width:760px){ .form{grid-template-columns:1fr} }
</style>

<body>
  <header>
    <h2>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h2>
    <div class="actions">
      <button id="btnCart">üß∫ –ö–æ—à–∏–∫ (<span id="cnt">0</span>)</button>
      <button id="btnCheckout" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </header>

  <nav class="tabs" id="tabs">
    <a class="tab" data-cat=""            href="#/catalog">–í—Å—ñ</a>
    <a class="tab" data-cat="devises"     href="#/catalog?cat=devises">–î–µ–≤–∞–π—Å–∏</a>
    <a class="tab" data-cat="liquids"     href="#/catalog?cat=liquids">–†—ñ–¥–∏–Ω–∏</a>
    <a class="tab" data-cat="cartridges"  href="#/catalog?cat=cartridges">–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ</a>
  </nav>

  <div id="root"></div>

  <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
  <div class="modal" id="cartModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="row">
        <h3>–ö–æ—à–∏–∫</h3>
        <button id="closeCart">‚úï</button>
      </div>
      <div id="cartBody"></div>
      <div class="row" style="margin-top:8px">
        <button id="clearCart" class="muted" style="border-color:#e5e7eb">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button id="goCheckout" class="primary">–î–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</button>
      </div>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π —Å–æ–≥–ª–∞—Å–∏—è -->
  <div class="gate" id="gate">
    <div class="box">
      <h3>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
      <div class="muted">–©–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏, –ø—ñ–¥—Ç–≤–µ—Ä–¥—å—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–µ:</div>
      <div class="checks">
        <label><input id="ch18" type="checkbox">–ú–µ–Ω—ñ –≤–∏–ø–æ–≤–Ω–∏–ª–æ—Å—è 18 —Ä–æ–∫—ñ–≤</label>
        <label><input id="chTerms" type="checkbox">–Ø –æ–∑–Ω–∞–π–æ–º–∏–≤—Å—è —Ç–∞ –ø—Ä–∏–π–º–∞—é –ø—Ä–∞–≤–∏–ª–∞ –º–∞–≥–∞–∑–∏–Ω—É</label>
      </div>
      <div class="rowend">
        <button id="gateCancel" class="muted">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button id="gateOk" class="primary" disabled>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
      </div>
    </div>
  </div>

<script>
/* ===== state & utils ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = (p,c)=>`${p} ${c||'UAH'}`;
const LS_CART   = "tgshop.cart.v1";
const LS_CONSENT= "tgshop.consent.v1";

let CART = new Map(); // sku->qty
let DATA = [];
let CAT  = "";

/* ===== consent (18+ & rules) ===== */
function needConsent(){ try{ return localStorage.getItem(LS_CONSENT)!=='1'; }catch{ return true; } }
function showGate(){ $('#gate').classList.add('show'); }
function hideGate(){ $('#gate').classList.remove('show'); }
function setConsent(){ try{ localStorage.setItem(LS_CONSENT,'1'); }catch{} }

$('#gateCancel').onclick = ()=> history.length>1 ? history.back() : alert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –±–µ–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.');
function updateGateBtn(){
  $('#gateOk').disabled = !($('#ch18').checked && $('#chTerms').checked);
}
$('#ch18').onchange = updateGateBtn;
$('#chTerms').onchange = updateGateBtn;
$('#gateOk').onclick = ()=>{ setConsent(); hideGate(); render(); };

/* ===== cart ===== */
function loadCart(){ try{ const raw = localStorage.getItem(LS_CART); if(raw) CART = new Map(JSON.parse(raw)); }catch{} }
function saveCart(){ try{ localStorage.setItem(LS_CART, JSON.stringify([...CART.entries()])); }catch{} }
function cartCount(){ let n=0; for(const q of CART.values()) n+=q; return n; }
function updCount(){ $('#cnt').textContent = cartCount(); }
function inTg(){ try{ return typeof Telegram!=='undefined' && Telegram.WebApp && Telegram.WebApp.sendData; }catch{ return false; }}

/* ===== data ===== */
async function fetchCatalog(){
  const r = await fetch('/api/catalog'); const j = await r.json();
  DATA = (j.items||[]).slice().sort((a,b)=> (a.category||'').localeCompare(b.category||'') || a.title.localeCompare(b.title));
}

/* ===== render helpers ===== */
function setTabs(cat){ CAT = cat || ""; $$('#tabs .tab').forEach(t=> t.classList.toggle('active', (t.dataset.cat||'')===CAT)); }

function renderCatalog(cat=""){
  setTabs(cat);
  const list = DATA.filter(p=> !CAT || (p.category||"")===CAT );
  const root = $('#root');
  if(!list.length){ root.innerHTML = `<div class="empty">–¢—É—Ç –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ</div>`; return; }

  root.innerHTML = `<div class="grid" id="grid"></div>`;
  const grid = $('#grid');

  list.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" alt="">
      <h4 style="margin:8px 0 4px">${p.title} ${p.availability==='preorder'?'<span class="muted">¬∑ –ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>':''}</h4>
      <div class="muted" style="min-height:38px">${p.description? p.description.slice(0,90):''}</div>
      <div class="row" style="margin-top:6px">
        <b>${fmt(p.price,p.currency)}</b>
        <div>
          <button data-act="add"  data-sku="${p.sku}">–î–æ–¥–∞—Ç–∏</button>
          <button data-act="open" data-sku="${p.sku}" class="primary">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</button>
        </div>
      </div>`;
    grid.appendChild(el);
  });

  grid.onclick = (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const sku = b.dataset.sku;
    if(b.dataset.act==='add'){
      CART.set(sku,(CART.get(sku)||0)+1); saveCart(); updCount();
    } else if(b.dataset.act==='open'){
      location.hash = '#/product/'+encodeURIComponent(sku);
    }
  };
}

<script>
function renderProduct(sku){
  const p = DATA.find(x=>x.sku===sku);
  const root = $('#root');
  if(!p){ root.innerHTML = `<div class="empty">–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`; return; }

  root.innerHTML = `
    <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="card">
      <div class="product">
        <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" alt="">
        <div>
          <h3 style="margin:0 0 6px">${p.title}</h3>
          <div class="muted" style="margin:0 0 10px">${p.description||''}</div>
          <div class="muted" style="margin:0 0 10px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <b>${p.category||'‚Äî'}</b></div>
          <div class="muted" style="margin:0 0 14px">–°—Ç–∞—Ç—É—Å: <b>${p.availability==='preorder'?'–ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':'–≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</b></div>
          <div class="row">
            <b style="font-size:18px">${fmt(p.price,p.currency)}</b>
            <div>
              <button id="minus">‚Äì</button>
              <span id="qty" style="display:inline-block;min-width:24px;text-align:center">1</span>
              <button id="plus">+</button>
              <button id="add" class="primary">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  let q=1; const $qty = $('#qty');
  $('#minus').onclick = ()=>{ if(q>1){ q--; $qty.textContent=q; } };
  $('#plus').onclick  = ()=>{ q++; $qty.textContent=q; };
  $('#add').onclick   = ()=>{ CART.set(sku,(CART.get(sku)||0)+q); saveCart(); updCount(); alert('–î–æ–¥–∞–Ω–æ'); };
}
</script>

  root.innerHTML = `
    <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="card">
      <div class="row" style="align-items:flex-start;gap:16px">
        <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" style="width:320px;max-width:46%;aspect-ratio:1/1;object-fit:cover;border-radius:12px">
        <div style="flex:1">
          <h3 style="margin:0 0 6px">${p.title}</h3>
          <div class="muted" style="margin-bottom:10px">${p.description||''}</div>
          <div class="muted" style="margin-bottom:10px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <b>${p.category||'‚Äî'}</b></div>
          <div class="muted" style="margin-bottom:14px">–°—Ç–∞—Ç—É—Å: <b>${p.availability==='preorder'?'–ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':'–≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</b></div>
          <div class="row">
            <b style="font-size:18px">${fmt(p.price,p.currency)}</b>
            <div>
              <button id="minus">‚Äì</button>
              <span id="qty" style="display:inline-block;min-width:24px;text-align:center">1</span>
              <button id="plus">+</button>
              <button id="add" class="primary">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  let q=1; const $qty = $('#qty');
  $('#minus').onclick = ()=>{ if(q>1){ q--; $qty.textContent=q; } };
  $('#plus').onclick  = ()=>{ q++; $qty.textContent=q; };
  $('#add').onclick   = ()=>{ CART.set(sku,(CART.get(sku)||0)+q); saveCart(); updCount(); alert('–î–æ–¥–∞–Ω–æ'); };
}

function renderCheckout(){
  const items = [...CART.entries()].map(([sku,qty])=>{
    const p = DATA.find(x=>x.sku===sku);
    return {sku,qty,title:p?.title||sku,price:p?.price||0,currency:p?.currency||'UAH'};
  });
  const total = items.reduce((s,i)=> s + i.price*i.qty, 0);
  const root = $('#root');

  // –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∏–∫ –∏–∑ Telegram
  let preUser = '';
  try{
    const u = Telegram?.WebApp?.initDataUnsafe?.user;
    if(u?.username) preUser = '@'+u.username;
  }catch{}

  root.innerHTML = `
    <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="card">
      <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</h3>
      ${items.length?`
        <div class="list">
          ${items.map(i=>`
            <div class="row">
              <div>${i.title} <span class="muted">√ó ${i.qty}</span></div>
              <div><b>${fmt(i.price*i.qty,i.currency)}</b></div>
            </div>`).join('')}
          <div class="row" style="border-top:1px dashed #e5e7eb;padding-top:8px">
            <div><b>–†–∞–∑–æ–º</b></div><div><b>${fmt(total,items[0]?.currency||'UAH')}</b></div>
          </div>
        </div>
      `: `<div class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`}

      <div class="form" style="margin-top:10px">
        <div><label>–ú—ñ—Å—Ç–æ<input id="city" placeholder="–ö–∏—ó–≤"></label></div>
        <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü<input id="branch" placeholder="‚Ññ25"></label></div>
        <div class="full"><label>–ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞<input id="receiver" placeholder="–Ü–º º—è –ü—Ä—ñ–∑–≤–∏—â–µ"></label></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω<input id="phone" placeholder="+380..."></label></div>
        <div class="full"><label>–ù—ñ–∫ —É Telegram <span class="muted">(–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</span>
          <input id="username" placeholder="@nickname" value="${preUser}"></label></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="backToCat">‚Üê –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø–æ–∫—É–ø–∫–∏</button>
        <button id="confirm" class="primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>
    </div>
  `;

  $('#backToCat').onclick = ()=>{ location.hash = '#/catalog'+(CAT?`?cat=${CAT}`:''); };
<script>
  $('#confirm').onclick = ()=>{
    const items = [...CART.entries()];
    if(!items.length){ alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }

    const city=$('#city').value.trim(),
          branch=$('#branch').value.trim(),
          receiver=$('#receiver').value.trim(),
          phone=$('#phone').value.trim(),
          username=$('#username').value.trim();

    if(!city||!branch||!receiver||!phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'); return; }
    if(!/^@[\w\d_]{3,}$/.test(username)){ alert('–í–∫–∞–∂—ñ—Ç—å –Ω—ñ–∫ —É Telegram (–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ @)'); return; }

    const payload = {
      type:'checkout',
      items:items.map(([sku,qty])=>({sku,qty})),
      city,branch,receiver,phone,username
    };

    if(!inTg()){
      alert('–©–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–¥–∞–≤—Ü—é, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å–∞–º–µ –≤ Telegram (–º—ñ–Ω—ñ-–¥–æ–¥–∞—Ç–æ–∫) —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ù–∞–¥—ñ—Å–ª–∞—Ç–∏¬ª.');
      return; // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞ –≤–Ω–µ Telegram
    }

    // –í Telegram: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
    try{ Telegram.WebApp.ready(); }catch{}
    try{ Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){ console.error(e); alert('–ù–µ –≤–¥–∞–ª–æ—Å—å –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.'); return; }

    renderSuccess();
    CART.clear(); saveCart(); updCount();
    setTimeout(()=>{ try{ Telegram.WebApp.close(); }catch{} }, 1200);
  };
</script>

  $('#confirm').onclick = ()=>{
    if(!items.length){ alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const city=$('#city').value.trim(),
          branch=$('#branch').value.trim(),
          receiver=$('#receiver').value.trim(),
          phone=$('#phone').value.trim(),
          username=$('#username').value.trim();
    if(!city||!branch||!receiver||!phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'); return; }
    if(!/^@[\w\d_]{3,}$/.test(username)){ alert('–í–∫–∞–∂—ñ—Ç—å –Ω—ñ–∫ —É Telegram (–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ @)'); return; }

    const payload = {type:'checkout',items:items.map(i=>({sku:i.sku,qty:i.qty})),
                     city,branch,receiver,phone,username};

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞ —Å—Ä–∞–∑—É
    renderSuccess();
    if(inTg()){
      try{ Telegram.WebApp.ready(); }catch{}
      try{ Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){ console.error(e); }
      // –∑–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 1.2—Å
      setTimeout(()=>{ try{ Telegram.WebApp.close(); }catch{} }, 1200);
    } else {
      alert('–©–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–¥–∞–≤—Ü—é, –≤—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ Telegram.');
    }
    // –∫–æ—Ä–∑–∏–Ω—É –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    CART.clear(); saveCart(); updCount();
  };
}

function renderSuccess(){
  $('#root').innerHTML = `
    <div class="card" style="text-align:center">
      <h3>‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ</h3>
      <div class="muted">–î—è–∫—É—î–º–æ! –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ —É Telegram –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.</div>
      <div style="margin-top:12px">
        <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É</a>
      </div>
    </div>
  `;
}

/* ===== simple router ===== */
function parseHash(){
  const h = location.hash || '#/catalog';
  if(h.startsWith('#/catalog')){
    const q = new URLSearchParams(h.split('?')[1]||'');
    return {view:'catalog', cat:(q.get('cat')||'')};
  }
  if(h.startsWith('#/product/')) return {view:'product', sku: decodeURIComponent(h.split('/')[2]||'')};
  if(h==='#/checkout') return {view:'checkout'};
  if(h==='#/success')  return {view:'success'};
  return {view:'catalog', cat:''};
}

async function render(){
  // –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–≥–ª–∞—Å–∏—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≥–µ–π—Ç –∏ –Ω–µ —Ä–∏—Å–æ–≤–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—É
  if(needConsent()){ showGate(); return; }

  loadCart(); updCount();
  if(DATA.length===0) await fetchCatalog();
  const r = parseHash();
  if(r.view==='catalog')  renderCatalog(r.cat);
  if(r.view==='product')  renderProduct(r.sku);
  if(r.view==='checkout') renderCheckout();
  if(r.view==='success')  renderSuccess();
}

window.addEventListener('hashchange', render);
window.addEventListener('DOMContentLoaded', ()=>{
  if(needConsent()) showGate();
  render();
});

/* ===== cart modal ===== */
function openCart(){
  const items = [...CART.entries()].map(([sku,qty])=>{
    const p = DATA.find(x=>x.sku===sku);
    return {sku,qty,title:p?.title||sku,price:p?.price||0,currency:p?.currency||'UAH'};
  });
  const body = $('#cartBody');
  if(!items.length){
    body.innerHTML = `<div class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`;
  } else {
    body.innerHTML = `
      <div class="list">
        ${items.map(i=>`
          <div class="row">
            <div>${i.title} <span class="muted">√ó ${i.qty}</span></div>
            <div><b>${fmt(i.price*i.qty,i.currency)}</b></div>
          </div>`).join('')}
      </div>`;
  }
  $('#cartModal').classList.add('show');
}
$('#btnCart').onclick = openCart;
$('#closeCart').onclick = ()=> $('#cartModal').classList.remove('show');
$('#goCheckout').onclick = ()=>{ $('#cartModal').classList.remove('show'); location.hash = '#/checkout'; };
$('#clearCart').onclick = ()=>{ CART.clear(); saveCart(); updCount(); openCart(); };
$('#cartModal').addEventListener('click', (e)=>{ if(e.target.id==='cartModal') $('#cartModal').classList.remove('show'); });

/* ===== header actions ===== */
$('#btnCheckout').onclick = ()=>{ location.hash = '#/checkout'; };
</script>
</body>
</html>

















