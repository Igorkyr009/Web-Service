<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω</title>
  <style>
    :root { --primary:#0ea5e9; --bg:#0b0f14; --panel:#0f1720; --line:#1f2a37; --text:#e7eef7; --muted:#9bb0c8; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0 auto;max-width:960px;padding:16px;background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    h2{margin:0}
    .actions{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:10px;border:1px solid #1e293b;background:#111827;color:var(--text);cursor:pointer}
    button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    button:disabled{opacity:.5;cursor:not-allowed}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 16px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--panel);cursor:pointer;font-size:14px}
    .chip.active{background:var(--primary);border-color:var(--primary);color:#fff}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:12px;cursor:pointer;transition:transform .06s ease}
    .card:hover{transform:translateY(-2px)}
    .card img{width:100%;border-radius:10px;aspect-ratio:3/2;object-fit:cover;background:#0b1220}
    .muted{color:var(--muted);min-height:36px;font-size:13px}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .price{font-weight:700}

    /* checkout */
    .checkout{display:grid;gap:12px}
    .items{border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:12px}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed var(--line)}
    .item:last-child{border-bottom:0}
    .sum{display:flex;justify-content:space-between;align-items:center;font-weight:700;margin-top:6px}
    .field{display:grid;gap:6px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #1e293b;background:#0b1220;color:var(--text)}
    .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .hint{color:#8aa0b8;font-size:13px}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:10}
    .modal.on{display:flex}
    .modal-card{max-width:740px;width:100%;background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
    .modal-body img{width:100%;border-radius:12px;aspect-ratio:3/2;object-fit:cover}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
    .close{background:transparent;border:1px solid var(--line);border-radius:8px;padding:6px 10px;color:var(--text)}
    @media (max-width:720px){ .modal-body{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <header>
    <h2>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h2>
    <div class="actions">
      <button id="btn-catalog" type="button">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button id="btn-cart"    type="button">üß∫ –ö–æ—à–∏–∫ (<span id="cart-count">0</span>)</button>
      <button id="btn-checkout" type="button" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </header>

  <!-- –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –º–µ—Å—Ç–æ -->
  <div id="chips" class="chips" style="display:none"></div>

  <main id="app"></main>

  <!-- –º–æ–¥–∞–ª–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <strong id="m-title"></strong>
        <button class="close" id="m-close" type="button">‚úï</button>
      </div>
      <div class="modal-body">
        <img id="m-img" alt="">
        <div>
          <div class="muted" id="m-cat"></div>
          <p id="m-desc" style="margin:8px 0 12px"></p>
          <div class="row" style="margin-top:12px">
            <div class="price" id="m-price"></div>
            <button class="primary" id="m-add" type="button">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ------- —Å–æ—Å—Ç–æ—è–Ω–∏–µ -------
  let CATALOG = null;                 // –∫—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞ (–º–∞—Å—Å–∏–≤)
  const CART = new Map();             // sku -> qty
  let SELECTED_CAT = '–£—Å–µ';           // –∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  const PLACEHOLDER = 'https://via.placeholder.com/600x400.png?text=No+Image';

  // ------- —É—Ç–∏–ª–∏—Ç—ã -------
  const $ = sel => document.querySelector(sel);
  const app = $('#app');
  const chipsEl = $('#chips');
  const cartCountEl = $('#cart-count');
  const fmt = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  const currency = (p,c) => `${fmt(p)} ${c||'UAH'}`;

  function normalizeImg(u){
    if(!u) return PLACEHOLDER;
    u = String(u).trim();
    if (!/^https?:\/\//i.test(u)) { if(!u.startsWith('/')) u='/'+u; return u; }
    if (/^http:\/\//i.test(u)) u = u.replace(/^http:\/\//i,'https://');
    return u;
  }

  function renderCartCount(){
    let n=0; for(const q of CART.values()) n+=q;
    cartCountEl.textContent = n;
  }

  function cartTotal() {
    let total=0, curr='UAH';
    if (!CATALOG) return {total:0,curr};
    for (const [sku,qty] of CART.entries()){
      const p = CATALOG.find(x=>x.sku===sku);
      if (p){ total += p.price*qty; curr = p.currency||curr; }
    }
    return {total,curr};
  }

  // ------- –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -------
  function categoriesFrom(items){
    const set = new Set(['–£—Å–µ']);
    items.forEach(p => { const c=(p.category||'').trim(); if(c) set.add(c); });
    return Array.from(set);
  }
  function renderChips(items){
    const cats = categoriesFrom(items);
    chipsEl.innerHTML = '';
    cats.forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'chip' + (cat===SELECTED_CAT?' active':'');
      b.textContent = cat;
      b.onclick = () => { SELECTED_CAT = cat; showCatalog(true); };
      chipsEl.appendChild(b);
    });
    chipsEl.style.display = cats.length>1 ? '' : 'none';
  }

  // ------- –º–æ–¥–∞–ª–∫–∞ —Ç–æ–≤–∞—Ä–∞ -------
  const modal = $('#modal'), mImg = $('#m-img'), mTitle = $('#m-title'),
        mDesc = $('#m-desc'), mPrice = $('#m-price'), mCat = $('#m-cat'), mAdd = $('#m-add');

  function openProduct(p){
    mImg.src = normalizeImg(p.image_url);
    mImg.onerror = () => { mImg.onerror=null; mImg.src=PLACEHOLDER; };
    mTitle.textContent = p.title;
    mDesc.textContent  = p.description || '‚Äî';
    mCat.textContent   = p.category ? `–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${p.category}` : '';
    mPrice.textContent = currency(p.price, p.currency);
    mAdd.onclick = () => { CART.set(p.sku, (CART.get(p.sku)||0)+1); renderCartCount(); closeModal(); };
    modal.classList.add('on');
  }
  function closeModal(){ modal.classList.remove('on'); }
  $('#m-close').onclick = closeModal;
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  // ------- –∫–∞—Ç–∞–ª–æ–≥ -------
  async function showCatalog(skipFetch=false) {
    $('header h2').textContent = 'üõç –í—ñ—Ç—Ä–∏–Ω–∞';
    if (!skipFetch || !CATALOG){
      const r = await fetch('/api/catalog', {cache:'no-store'});
      const data = await r.json();
      CATALOG = (data.items||[]).filter(x=>x.is_active);
      renderChips(CATALOG);
    }

    const grid = document.createElement('div');
    grid.className = 'grid';

    const list = (SELECTED_CAT==='–£—Å–µ')
      ? CATALOG
      : CATALOG.filter(p => (p.category||'').trim() === SELECTED_CAT);

    list.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${normalizeImg(p.image_url)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'" alt="">
        <h4>${p.title}</h4>
        <div class="muted">${p.description ? (p.description.length>90 ? p.description.slice(0,90)+'‚Ä¶' : p.description) : ''}</div>
        <div class="row">
          <div class="price">${currency(p.price, p.currency)}</div>
          <button class="primary" type="button">–î–æ–¥–∞—Ç–∏</button>
        </div>
      `;
      // –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
      card.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') return; // –∫–Ω–æ–ø–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
        openProduct(p);
      });
      // –∫–Ω–æ–ø–∫–∞ "–î–æ–¥–∞—Ç–∏"
      card.querySelector('button').onclick = (e) => {
        e.stopPropagation();
        CART.set(p.sku, (CART.get(p.sku)||0)+1);
        renderCartCount();
      };
      grid.appendChild(card);
    });

    app.replaceChildren(grid);
  }

  // ------- –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è -------
  function showCheckout(){
    if (CART.size===0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏.'); location.hash='catalog'; return; }
    $('header h2').textContent = 'üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è';

    const wrap = document.createElement('div');
    wrap.className = 'checkout';

    const box = document.createElement('div'); box.className='items';
    for (const [sku,qty] of CART.entries()){
      const p = CATALOG?.find(x=>x.sku===sku); if(!p) continue;
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div>${p.title}</div><div>√ó ${qty}</div><div>${currency(p.price*qty,p.currency)}</div>`;
      box.appendChild(row);
    }
    const {total,curr} = cartTotal();
    const sum = document.createElement('div'); sum.className='sum';
    sum.innerHTML = `<span>–í—Å—å–æ–≥–æ</span><span>${currency(total,curr)}</span>`;
    box.appendChild(sum);

    const f = document.createElement('div');
    f.innerHTML = `
      <div class="field"><label>–ú—ñ—Å—Ç–æ</label><input id="city" placeholder="–ö–∏—ó–≤"></div>
      <div class="field"><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label><input id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ25"></div>
      <div class="field"><label>–û—Ç—Ä–∏–º—É–≤–∞—á</label><input id="receiver" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ"></div>
      <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="phone" placeholder="+380..."><div class="hint">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.</div></div>
      <div class="bar"><button id="confirm" class="primary" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button></div>
    `;
    wrap.appendChild(box); wrap.appendChild(f);
    app.replaceChildren(wrap);

    $('#confirm').onclick = () => {
      const city=$('#city').value.trim(), branch=$('#branch').value.trim(),
            receiver=$('#receiver').value.trim(), phone=$('#phone').value.trim();
      if(!city||!branch||!receiver||!phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è.'); return; }
      const items = Array.from(CART.entries()).map(([sku,qty])=>({sku,qty}));
      const payload = {type:'checkout', items, city, branch, receiver, phone};

      if (window.Telegram && Telegram.WebApp){
        Telegram.WebApp.ready();
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.close();
      } else {
        alert('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–µ–º–æ):\n'+JSON.stringify(payload,null,2));
      }
    };
  }

  // ------- —Ä–æ—É—Ç–µ—Ä -------
  function wantsCheckout(){
    const q=new URLSearchParams(location.search);
    return location.hash==='#checkout' || (q.get('view')||'').toLowerCase()==='checkout';
  }
  function renderByHash(){
    const v = (location.hash || (wantsCheckout() ? '#checkout' : '#catalog')).toLowerCase();
    if (v==='#checkout') showCheckout(); else showCatalog();
  }

  document.addEventListener('DOMContentLoaded', () => {
    try{ sessionStorage.removeItem('ui_step'); }catch(e){}
    renderByHash();
    renderCartCount();
  });
  window.addEventListener('hashchange', renderByHash);

  // –≤–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
  $('#btn-catalog').addEventListener('click', ()=> location.hash='catalog');
  $('#btn-checkout').addEventListener('click', ()=>{
    if (!CART.size) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è.');
    location.hash='checkout';
  });
  $('#btn-cart').addEventListener('click', ()=> alert(
    Array.from(CART.entries()).map(([s,q])=>`${s} √ó ${q}`).join('\n') || '–ü–æ—Ä–æ–∂–Ω—å–æ'
  ));
</script>
</body>
</html>





