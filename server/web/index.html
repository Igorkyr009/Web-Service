<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–∞–≥–∞–∑–∏–Ω</title>
  <style>
    :root { --primary:#0ea5e9; --bg:#0b0f14; --panel:#0f1720; --line:#1f2a37; --text:#e7eef7; --muted:#9bb0c8; --bad:#ef4444; --ok:#10b981; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0 auto;max-width:960px;padding:16px;background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    h2{margin:0}
    .actions{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:10px;border:1px solid #1e293b;background:#111827;color:var(--text);cursor:pointer}
    button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 16px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--panel);cursor:pointer;font-size:14px}
    .chip.active{background:var(--primary);border-color:var(--primary);color:#fff}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{border:1px solid var(--line);background:var(--panel);border-radius:14px;padding:12px;cursor:pointer;transition:transform .06s ease; position:relative}
    .card:hover{transform:translateY(-2px)}
    .card img{width:100%;border-radius:10px;aspect-ratio:3/2;object-fit:cover;background:#0b1220}
    .muted{color:var(--muted);min-height:36px;font-size:13px}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .price{font-weight:700}
    .badge{position:absolute;left:10px;top:10px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1a27}
    .pre{background:#1f1027;border-color:#3a1b4a}

    /* home */
    .home{display:grid;gap:16px}
    .tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .tile{background:linear-gradient(180deg,#0f1720,#0d1420);border:1px solid var(--line);border-radius:14px;padding:24px;cursor:pointer;text-align:center}
    .tile:hover{transform:translateY(-2px)}
    .tile h3{margin:0 0 8px}
    .tile p{margin:0;color:var(--muted);font-size:13px}

    /* product page */
    .product{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .product img{width:100%;border-radius:12px;aspect-ratio:3/2;object-fit:cover;background:#0b1220}
    .back{background:transparent;border:1px solid var(--line);border-radius:8px;padding:6px 10px;color:var(--text);margin-bottom:12px}
    @media (max-width:720px){ .product{grid-template-columns:1fr} }

    /* checkout */
    .checkout{display:grid;gap:12px}
    .items{border:1px solid var(--line);background:var(--panel);border-radius:12px;padding:12px}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed var(--line)}
    .item:last-child{border-bottom:0}
    .sum{display:flex;justify-content:space-between;align-items:center;font-weight:700;margin-top:6px}
    .field{display:grid;gap:6px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #1e293b;background:#0b1220;color:#e7eef7}
    .bar{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .hint{color:#8aa0b8;font-size:13px}

    /* cart modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:10}
    .modal.on{display:flex}
    .modal-card{max-width:720px;width:100%;background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
    .close{background:transparent;border:1px solid var(--line);border-radius:8px;padding:6px 10px;color:var(--text)}
    .cart-list{padding:12px}
    .cart-row{display:grid;grid-template-columns:auto 1fr auto auto auto;gap:10px;align-items:center;border-bottom:1px dashed var(--line);padding:8px 0}
    .cart-row img{width:60px;height:40px;object-fit:cover;border-radius:8px;background:#0b1220}
    .qty{display:flex;gap:6px;align-items:center}
    .qty button{padding:4px 8px}
    .cart-foot{display:flex;justify-content:space-between;align-items:center;padding:12px;border-top:1px solid var(--line)}
  </style>
</head>
<body>

  <header>
    <h2>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h2>
    <div class="actions">
      <button id="btn-catalog"  type="button">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button id="btn-cart"     type="button">üß∫ –ö–æ—à–∏–∫ (<span id="cart-count">0</span>)</button>
      <button id="btn-checkout" type="button" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </header>

  <div id="chips" class="chips" style="display:none"></div>
  <main id="app"></main>

  <!-- cart modal -->
  <div id="cartModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong>–ö–æ—à–∏–∫</strong>
        <button class="close" id="cartClose" type="button">‚úï</button>
      </div>
      <div id="cartList" class="cart-list"></div>
      <div class="cart-foot">
        <div>–í—Å—å–æ–≥–æ: <b id="cartSum">0 UAH</b></div>
        <div style="display:flex;gap:8px">
          <button id="clearCart" class="ghost">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          <button id="goCheckout" class="primary">–î–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------------- state ----------------
  let CATALOG = null;                 // –∫—ç—à –∫–∞—Ç–∞–ª–æ–≥–∞
  const CART  = new Map();            // sku -> qty (persist)
  let SELECTED_CAT = '–£—Å–µ';
  const PLACEHOLDER = 'https://via.placeholder.com/600x400.png?text=No+Image';
  const CART_KEY = 'tgshop_cart_v1';

  // ---------------- utils ----------------
  const $ = sel => document.querySelector(sel);
  const app = $('#app'), chipsEl = $('#chips'), cartCountEl = $('#cart-count');
  const fmt = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  const currency = (p,c) => `${fmt(p)} ${c||'UAH'}`;

  function normalizeImg(u){
    if(!u) return PLACEHOLDER;
    u = String(u).trim();
    if (!/^https?:\/\//i.test(u)) { if(!u.startsWith('/')) u='/'+u; return u; }
    if (/^http:\/\//i.test(u)) u = u.replace(/^http:\/\//i,'https://');
    return u;
  }

  // ----- cart persist -----
  function loadCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      Object.entries(obj).forEach(([sku,qty])=>{ if(qty>0) CART.set(sku,qty); });
    }catch(e){}
  }
  function saveCart(){
    const obj = {}; for (const [sku,qty] of CART.entries()) obj[sku]=qty;
    try{ localStorage.setItem(CART_KEY, JSON.stringify(obj)); }catch(e){}
  }
  function renderCartCount(){
    let n=0; for(const q of CART.values()) n+=q;
    cartCountEl.textContent = n;
  }
  function addToCart(sku, qty=1){
    CART.set(sku, (CART.get(sku)||0) + qty);
    renderCartCount(); saveCart(); renderCartModal(); // –æ–±–Ω–æ–≤–∏–º –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
  }

  function cartTotal() {
    let total=0, curr='UAH';
    if (!CATALOG) return {total:0,curr};
    for (const [sku,qty] of CART.entries()){
      const p = CATALOG.find(x=>x.sku===sku);
      if (p){ total += p.price*qty; curr = p.currency||curr; }
    }
    return {total,curr};
  }

  // ---------------- categories ----------------
  function categoriesFrom(items){
    const set = new Set(['–£—Å–µ']);
    items.forEach(p => { const c=(p.category||'').trim(); if(c) set.add(c); });
    return Array.from(set);
  }
  function renderChips(items){
    const cats = categoriesFrom(items);
    chipsEl.innerHTML = '';
    cats.forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'chip' + (cat===SELECTED_CAT?' active':'');
      b.textContent = cat;
      b.onclick = () => { SELECTED_CAT = cat; location.hash = '#catalog'; };
      chipsEl.appendChild(b);
    });
    chipsEl.style.display = cats.length>1 ? '' : 'none';
  }

  // ---------------- views ----------------
  async function ensureCatalog(){
    if (CATALOG) return;
    const r = await fetch('/api/catalog', {cache:'no-store'});
    const data = await r.json();
    CATALOG = (data.items||[]).filter(x=>x.is_active);
    renderChips(CATALOG);
  }

  // Home: —Ç—Ä–∏ –±–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏
  async function showHome(){
    $('header h2').textContent = 'üõç –í—ñ—Ç—Ä–∏–Ω–∞';
    await ensureCatalog();

    const wrap = document.createElement('div');
    wrap.className = 'home';
    const tiles = document.createElement('div');
    tiles.className = 'tiles';

    const BTN = [
      {title:'–î–µ–≤–∞–π—Å–∏',  cat:'–î–µ–≤–∞–π—Å–∏',  desc:'–°–∏–≥–∞—Ä–µ—Ç–∏, –ø–æ–¥-—Å–∏—Å—Ç–µ–º–∏ —Ç–æ—â–æ'},
      {title:'–†—ñ–¥–∏–Ω–∏',   cat:'–†—ñ–¥–∏–Ω–∏',   desc:'–°–º–∞–∫–∏ –Ω–∞ –±—É–¥—å-—è–∫–∏–π —Å–º–∞–∫'},
      {title:'–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ',cat:'–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ',desc:'–°—É–º—ñ—Å–Ω—ñ –º–æ–¥–µ–ª—ñ —Ç–∞ –±—Ä–µ–Ω–¥–∏'},
    ];
    BTN.forEach(b=>{
      const t = document.createElement('div');
      t.className='tile';
      t.innerHTML = `<h3>${b.title}</h3><p>${b.desc}</p>`;
      t.onclick = ()=>{ SELECTED_CAT = b.cat; location.hash = '#catalog'; };
      tiles.appendChild(t);
    });

    const all = document.createElement('button');
    all.className='primary'; all.textContent='–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥';
    all.onclick = ()=>{ SELECTED_CAT = '–£—Å–µ'; location.hash = '#catalog'; };

    wrap.appendChild(tiles);
    wrap.appendChild(all);
    app.replaceChildren(wrap);
  }

  // –ö–∞—Ç–∞–ª–æ–≥
  async function showCatalog(){
    $('header h2').textContent = 'üõç –í—ñ—Ç—Ä–∏–Ω–∞';
    await ensureCatalog();

    const grid = document.createElement('div');
    grid.className = 'grid';

    const list = (SELECTED_CAT==='–£—Å–µ')
      ? CATALOG
      : CATALOG.filter(p => (p.category||'').trim() === SELECTED_CAT);

    list.forEach(p=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${normalizeImg(p.image_url)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'" alt="">
        <span class="badge ${p.availability==='preorder'?'pre':''}">
          ${p.availability==='preorder' ? '–ü–µ—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è' : '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}
        </span>
        <h4 style="margin-top:8px">${p.title}</h4>
        <div class="muted">${p.description ? (p.description.length>90 ? p.description.slice(0,90)+'‚Ä¶' : p.description) : ''}</div>
        <div class="row">
          <div class="price">${currency(p.price, p.currency)}</div>
          <button class="primary" type="button">–î–æ–¥–∞—Ç–∏</button>
        </div>
      `;
      card.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') return;
        location.hash = '#product/' + encodeURIComponent(p.sku);
      });
      card.querySelector('button').onclick = (e) => {
        e.stopPropagation();
        addToCart(p.sku, 1);
      };
      grid.appendChild(card);
    });

    app.replaceChildren(grid);
  }

  // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞
  async function showProduct(sku){
    await ensureCatalog();
    const p = CATALOG.find(x=>x.sku===sku);
    if (!p){ alert('–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); location.hash='#catalog'; return; }

    $('header h2').textContent = 'üì¶ –¢–æ–≤–∞—Ä';

    const back = document.createElement('button');
    back.className='back'; back.textContent='‚Üê –î–æ –∫–∞—Ç–∞–ª–æ–≥—É';
    back.onclick = ()=> history.length>1 ? history.back() : (location.hash='#catalog');

    const page = document.createElement('div');
    page.className='product';
    page.innerHTML = `
      <img src="${normalizeImg(p.image_url)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'" alt="">
      <div>
        <div class="badge ${p.availability==='preorder'?'pre':''}" style="display:inline-block;margin-bottom:8px">
          ${p.availability==='preorder' ? '–ü–µ—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è' : '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}
        </div>
        <h3 style="margin-top:6px">${p.title}</h3>
        <div class="muted" style="margin:6px 0 10px">${p.category ? ('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: '+p.category) : ''}</div>
        <p>${p.description || '‚Äî'}</p>
        <div class="row" style="margin-top:12px">
          <div class="price">${currency(p.price, p.currency)}</div>
          <button id="p-add" class="primary" type="button">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
        </div>
      </div>
    `;

    app.replaceChildren(back, page);
    $('#p-add').onclick = ()=> addToCart(p.sku, 1);
  }

  // –ö–æ—à–∏–∫ (–º–æ–¥–∞–ª–∫–∞)
  function renderCartModal(){
    const list = $('#cartList');
    list.innerHTML = '';
    if (!CATALOG) return;
    for (const [sku,qty] of CART.entries()){
      const p = CATALOG.find(x=>x.sku===sku);
      if (!p) continue;
      const row = document.createElement('div');
      row.className = 'cart-row';
      row.innerHTML = `
        <img src="${normalizeImg(p.image_url)}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
        <div>
          <div><b>${p.title}</b></div>
          <div class="muted" style="font-size:12px">${p.category || ''}</div>
        </div>
        <div class="qty">
          <button data-act="dec">‚àí</button>
          <span>${qty}</span>
          <button data-act="inc">+</button>
        </div>
        <div>${currency(p.price*qty, p.currency)}</div>
        <button data-act="del" class="ghost" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">üóë</button>
      `;
      row.querySelector('[data-act="inc"]').onclick = ()=>{ addToCart(sku, 1); };
      row.querySelector('[data-act="dec"]').onclick = ()=>{
        const q = (CART.get(sku)||0)-1;
        if (q<=0) CART.delete(sku); else CART.set(sku,q);
        renderCartCount(); saveCart(); renderCartModal();
      };
      row.querySelector('[data-act="del"]').onclick = ()=>{
        CART.delete(sku); renderCartCount(); saveCart(); renderCartModal();
      };
      list.appendChild(row);
    }
    const {total,curr} = cartTotal();
    $('#cartSum').textContent = currency(total,curr);
  }

  function openCart(){
    renderCartModal();
    $('#cartModal').classList.add('on');
  }
  function closeCart(){
    $('#cartModal').classList.remove('on');
  }

  // –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è
  async function showCheckout(){
    if (CART.size===0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏.'); location.hash='catalog'; return; }
    $('header h2').textContent = 'üìù –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è';
    await ensureCatalog();

    const wrap = document.createElement('div'); wrap.className='checkout';
    const box = document.createElement('div'); box.className='items';
    for (const [sku,qty] of CART.entries()){
      const p = CATALOG?.find(x=>x.sku===sku); if(!p) continue;
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `<div>${p.title}</div><div>√ó ${qty}</div><div>${currency(p.price*qty,p.currency)}</div>`;
      box.appendChild(row);
    }
    const {total,curr} = cartTotal();
    const sum = document.createElement('div'); sum.className='sum';
    sum.innerHTML = `<span>–í—Å—å–æ–≥–æ</span><span>${currency(total,curr)}</span>`;
    box.appendChild(sum);

    // –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–∏—Ç—å username –∏–∑ Telegram WebApp
    let tgUser = '';
    try {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
        tgUser = Telegram.WebApp.initDataUnsafe.user.username || '';
      }
    } catch(e){}

    const f = document.createElement('div');
    f.innerHTML = `
      <div class="field"><label>–ú—ñ—Å—Ç–æ</label><input id="city" placeholder="–ö–∏—ó–≤"></div>
      <div class="field"><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label><input id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ25"></div>
      <div class="field"><label>–û—Ç—Ä–∏–º—É–≤–∞—á</label><input id="receiver" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ-–±–∞—Ç—å–∫–æ–≤—ñ"></div>
      <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="phone" placeholder="+380..."><div class="hint">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.</div></div>
      <div class="field"><label>–Æ–∑–µ—Ä–Ω–µ–π–º Telegram</label><input id="username" placeholder="@nickname" value="${tgUser ? '@'+tgUser : ''}"><div class="hint">–Ø–∫—â–æ –Ω–µ–º–∞—î ‚Äî –∑–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º.</div></div>
      <div class="bar"><button id="confirm" class="primary" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button></div>
    `;
    wrap.appendChild(box); wrap.appendChild(f); app.replaceChildren(wrap);

    $('#confirm').onclick = () => {
      const city=$('#city').value.trim(), branch=$('#branch').value.trim(),
            receiver=$('#receiver').value.trim(), phone=$('#phone').value.trim(),
            username=$('#username').value.trim();
      if(!city||!branch||!receiver||!phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è (–æ–∫—Ä—ñ–º —é–∑–µ—Ä–Ω–µ–π–º—É).'); return; }
      const items = Array.from(CART.entries()).map(([sku,qty])=>({sku,qty}));
      const payload = {type:'checkout', items, city, branch, receiver, phone, username};

      if (window.Telegram && Telegram.WebApp){
        Telegram.WebApp.ready();
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.close();
      } else {
        alert('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–µ–º–æ):\n'+JSON.stringify(payload,null,2));
      }
    };
  }

  // ---------------- router ----------------
  function route(){
    const h = (location.hash || '#home').slice(1);
    const [path, arg] = h.split('/');

    chipsEl.style.display = (path==='catalog') ? '' : 'none';

    if (path==='home')     return showHome();
    if (path==='catalog')  return showCatalog();
    if (path==='product')  return showProduct(decodeURIComponent(arg||''));
    if (path==='checkout') return showCheckout();

    location.hash = '#home';
  }

  // init
  loadCart(); renderCartCount();
  document.addEventListener('DOMContentLoaded', route);
  window.addEventListener('hashchange', route);

  // top buttons
  $('#btn-catalog').addEventListener('click', ()=> location.hash='#catalog');
  $('#btn-checkout').addEventListener('click', ()=>{
    if (!CART.size) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Ä–æ–∂–Ω—è.');
    location.hash='#checkout';
  });
  $('#btn-cart').addEventListener('click', openCart);

  // cart modal events
  $('#cartClose').addEventListener('click', closeCart);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCart(); });
  $('#goCheckout').addEventListener('click', ()=>{ closeCart(); if(!CART.size) return; location.hash='#checkout'; });
  $('#clearCart').addEventListener('click', ()=>{
    CART.clear(); renderCartCount(); saveCart(); renderCartModal();
  });
  $('#cartModal').addEventListener('click', (e)=>{ if(e.target.id==='cartModal') closeCart(); });
</script>
</body>
</html>










