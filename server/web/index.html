<!doctype html><html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–∞–≥–∞–∑–∏–Ω</title>

<style>
  *,*::before,*::after{box-sizing:border-box}
  body{font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0 auto;max-width:980px;padding:16px;background:#fafafa;color:#0f172a}
  h2,h3,h4{margin:0 0 10px}
  a{color:inherit;text-decoration:none}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:8px}
  .actions{display:flex;gap:8px}
  button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer}
  .primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .muted{color:#64748b}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .tab{padding:8px 12px;border:1px solid #e5e7eb;border-radius:999px}
  .tab.active{background:#111827;border-color:#111827;color:#fff}
  #root{min-height:50vh}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
  .card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;background:#f3f4f6}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .back{display:inline-block;margin:8px 0}

  .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form .full{grid-column:1 / -1}
  input,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .modal.show{display:flex}
  .sheet{width:min(92vw,520px);max-height:80vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid #e5e7eb;padding:14px}
  .list{display:grid;gap:8px;margin:8px 0}
  .empty{padding:24px;border:1px dashed #e5e7eb;background:#fff;border-radius:14px;text-align:center;color:#64748b}

  .product{display:grid;grid-template-columns:340px 1fr;gap:16px}
  .product img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:12px;background:#f3f4f6}
  @media (max-width:860px){ .product{grid-template-columns:1fr} }

  .gate{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .gate.show{display:flex}
  .gate .box{width:min(94vw,640px);background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  .checks{display:grid;gap:8px;margin:12px 0}
  .checks label{display:flex;gap:10px;align-items:flex-start;cursor:pointer}
  .gate .rowend{display:flex;justify-content:flex-end;gap:8px}
  @media (max-width:760px){ .form{grid-template-columns:1fr} }
</style>

<body>
<header>
  <h2>üõç –ú–∞–≥–∞–∑–∏–Ω</h2>
  <div class="actions">
    <button id="btnCart">üß∫ –ö–æ—à–∏–∫ (<span id="c">0</span>)</button>
    <button id="btnBuy" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
  </div>
</header>

<div class="tabs" id="tabs"></div>
<div id="root"></div>

<!-- –û–∫–Ω–æ –∫–æ—Ä–∑–∏–Ω—ã -->
<div class="modal" id="modalCart">
  <div class="sheet">
    <h3>–ö–æ—à–∏–∫</h3>
    <div id="cartList" class="list"></div>
    <div class="row" style="margin-top:8px">
      <div id="cartTotal" class="muted"></div>
      <div>
        <button id="goCheckout" class="primary">–î–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</button>
        <button id="closeCart">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>
  </div>
</div>

<!-- –≠–∫—Ä–∞–Ω —Å–æ–≥–ª–∞—Å–∏—è 18+ -->
<div class="gate" id="gate">
  <div class="box">
    <h3>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
    <div class="muted">–©–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏, –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å, —â–æ –≤–∞–º —î 18 —Ä–æ–∫—ñ–≤, —ñ –≤–∏ –ø–æ–≥–æ–¥–∂—É—î—Ç–µ—Å—å –∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –º–∞–≥–∞–∑–∏–Ω—É.</div>
    <div class="checks">
      <label><input type="checkbox" id="ch18"> –ú–µ–Ω—ñ –≤–∏–ø–æ–≤–Ω–∏–ª–æ—Å—è 18 —Ä–æ–∫—ñ–≤</label>
      <label><input type="checkbox" id="chrules"> –Ø –ø—Ä–∏–π–º–∞—é –ø—Ä–∞–≤–∏–ª–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫—É</label>
    </div>
    <div class="rowend">
      <button id="gateAccept" class="primary">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
const LS_CART    = "tgshop.cart.v1";
const LS_CONSENT = "tgshop.consent.v2";
let DATA = [];
let CART = new Map();
let CAT  = "";   // —Ç–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è

const CATS = [
  {id:"",            title:"–£—Å—ñ"},
  {id:"devices",     title:"–ü—Ä–∏—Å—Ç—Ä–æ—ó"},
  {id:"liquids",     title:"–†—ñ–¥–∏–Ω–∏"},
  {id:"cartridges",  title:"–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ"},
];

function inTg(){ try{ return !!(window.Telegram && Telegram.WebApp); }catch{ return false; } }

function loadCart(){
  try{
    const raw = localStorage.getItem(LS_CART);
    CART = new Map(raw ? JSON.parse(raw) : []);
  }catch{
    CART = new Map();
  }
}
function saveCart(){
  try{ localStorage.setItem(LS_CART, JSON.stringify([...CART.entries()])); }catch{}
}
function updCount(){
  let n=0; for(const q of CART.values()) n+=q;
  $('#c').textContent = n;
}

function fmt(p,c){ return `${p} ${c||'UAH'}`; }

async function fetchCatalog(){
  const r = await fetch('/api/catalog');
  const j = await r.json();
  DATA = j.items || [];
}

function renderTabs(){
  const el = $('#tabs');
  el.innerHTML = CATS.map(x=>`<a class="tab ${CAT===x.id?'active':''}" data-id="${x.id}" href="#/catalog${x.id?('?cat='+x.id):''}">${x.title}</a>`).join('');
  [...el.querySelectorAll('.tab')].forEach(a=>{
    a.onclick = (e)=>{ e.preventDefault(); CAT=a.dataset.id; renderCatalog(); }
  });
}

function renderCatalog(){
  renderTabs();
  const list = (CAT? DATA.filter(x=>x.category===CAT) : DATA);
  const root = $('#root');
  if(!list.length){ root.innerHTML = `<div class="empty">–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</div>`; return; }
  root.innerHTML = `<div class="grid">` + list.map(p=>`
    <div class="card">
      <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" alt="">
      <h4 style="margin:8px 0 6px">${p.title}</h4>
      <div class="muted" style="min-height:40px">${p.description||''}</div>
      <div class="row" style="margin-top:8px">
        <b>${fmt(p.price,p.currency)}</b>
        <div>
          <button data-sku="${p.sku}" class="toCart">–î–æ–¥–∞—Ç–∏</button>
          <a class="primary" href="#/product/${encodeURIComponent(p.sku)}">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a>
        </div>
      </div>
    </div>
  `).join('') + `</div>`;
  [...root.querySelectorAll('.toCart')].forEach(b=>{
    b.onclick = ()=>{ const sku=b.dataset.sku; CART.set(sku,(CART.get(sku)||0)+1); saveCart(); updCount(); }
  });
}

function renderProduct(sku){
  const p = DATA.find(x=>x.sku===sku);
  const root = $('#root');
  if(!p){ root.innerHTML = `<div class="empty">–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`; return; }
  root.innerHTML = `
    <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="card">
      <div class="product">
        <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" alt="">
        <div>
          <h3 style="margin:0 0 6px">${p.title}</h3>
          <div class="muted" style="margin:0 0 10px">${p.description||''}</div>
          <div class="muted" style="margin:0 0 10px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <b>${p.category||'‚Äî'}</b></div>
          <div class="muted" style="margin:0 0 14px">–°—Ç–∞—Ç—É—Å: <b>${p.availability==='preorder'?'–ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':'–≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</b></div>
          <div class="row">
            <b style="font-size:18px">${fmt(p.price,p.currency)}</b>
            <div>
              <button id="minus">‚Äì</button>
              <span id="qty" style="display:inline-block;min-width:24px;text-align:center">1</span>
              <button id="plus">+</button>
              <button id="add" class="primary">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  let q=1; const $qty = $('#qty');
  $('#minus').onclick = ()=>{ if(q>1){ q--; $qty.textContent=q; } };
  $('#plus').onclick  = ()=>{ q++; $qty.textContent=q; };
  $('#add').onclick   = ()=>{ CART.set(sku,(CART.get(sku)||0)+q); saveCart(); updCount(); alert('–î–æ–¥–∞–Ω–æ'); };
}

function renderCheckout(){
  const items=[...CART.entries()].map(([sku,qty])=>{
    const p=DATA.find(x=>x.sku===sku); return p?{...p,qty}:null;
  }).filter(Boolean);
  const root=$('#root');
  if(!items.length){
    root.innerHTML = `<div class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`;
    return;
  }
  const total = items.reduce((s,p)=>s+p.price*p.qty,0);
  root.innerHTML = `
    <div class="card">
      <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</h3>
      <div class="list" id="sum">
        ${items.map(p=>`<div class="row"><div>${p.title} √ó ${p.qty}</div><b>${fmt(p.price*p.qty,p.currency)}</b></div>`).join('')}
        <div class="row" style="border-top:1px solid #e5e7eb;padding-top:8px"><div><b>–†–∞–∑–æ–º</b></div><b>${fmt(total,items[0].currency)}</b></div>
      </div>
      <div class="form" style="margin-top:10px">
        <div><label class="muted">–ú—ñ—Å—Ç–æ<input id="city" placeholder="–ö–∏—ó–≤"></label></div>
        <div><label class="muted">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü<input id="branch" placeholder="‚Ññ25"></label></div>
        <div><label class="muted">–ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞<input id="receiver" placeholder="–Ü–≤–∞–Ω –Ü–≤–∞–Ω–æ–≤"></label></div>
        <div><label class="muted">–¢–µ–ª–µ—Ñ–æ–Ω<input id="phone" placeholder="+380..."></label></div>
        <div class="full"><label class="muted">–ù—ñ–∫ —É Telegram (–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)<input id="username" placeholder="@username"></label></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="muted">–ü—ñ—Å–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –º–∏ –∑–≤ º—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.</div>
        <button id="confirm" class="primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>
    </div>`;
  $('#confirm').onclick = ()=>{
    if(!CART.size){ alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const city=$('#city').value.trim(),
          branch=$('#branch').value.trim(),
          receiver=$('#receiver').value.trim(),
          phone=$('#phone').value.trim(),
          username=$('#username').value.trim();
    if(!city||!branch||!receiver||!phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'); return; }
    if(!/^@[\w\d_]{3,}$/.test(username)){ alert('–í–∫–∞–∂—ñ—Ç—å –Ω—ñ–∫ —É Telegram (–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ @)'); return; }

    const payload = {
      type:'checkout',
      items:[...CART.entries()].map(([sku,qty])=>({sku,qty})),
      city,branch,receiver,phone,username
    };

    if(!inTg()){
      alert('–©–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–¥–∞–≤—Ü—é, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É —Å–∞–º–µ –≤ Telegram (–º—ñ–Ω—ñ-–¥–æ–¥–∞—Ç–æ–∫) —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ù–∞–¥—ñ—Å–ª–∞—Ç–∏¬ª.');
      return;
    }
    try{ Telegram.WebApp.ready(); }catch{}
    try{ Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){ console.error(e); alert('–ù–µ –≤–¥–∞–ª–æ—Å—å –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏.'); return; }

    renderSuccess();
    CART.clear(); saveCart(); updCount();
    setTimeout(()=>{ try{ Telegram.WebApp.close(); }catch{} }, 1200);
  };
}

function renderSuccess(){
  $('#root').innerHTML = `
    <div class="card" style="text-align:center">
      <h3>‚úÖ –í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω</h3>
      <div class="muted">–î—è–∫—É—î–º–æ! –ú–∏ —Å–∫–æ—Ä–æ –∑ –≤–∞–º–∏ –∑–≤ º—è–∂–µ–º–æ—Å—è.</div>
    </div>`;
}

function openCart(){
  const items=[...CART.entries()].map(([sku,qty])=>{
    const p=DATA.find(x=>x.sku===sku); return p?{...p,qty}:null;
  }).filter(Boolean);
  const list=$('#cartList');
  const totalEl=$('#cartTotal');
  if(!items.length){
    list.innerHTML = `<div class="empty">–ü–æ—Ä–æ–∂–Ω—å–æ</div>`;
    totalEl.textContent = '';
  }else{
    list.innerHTML = items.map(p=>`
      <div class="row">
        <div>${p.title} √ó ${p.qty}</div>
        <div>
          <button data-sku="${p.sku}" class="minus">‚Äì</button>
          <button data-sku="${p.sku}" class="plus">+</button>
          <b>${fmt(p.price*p.qty,p.currency)}</b>
        </div>
      </div>
    `).join('');
    const total = items.reduce((s,p)=>s+p.price*p.qty,0);
    totalEl.textContent = `–†–∞–∑–æ–º: ${fmt(total, items[0].currency)}`;
    list.querySelectorAll('.minus').forEach(b=>b.onclick=()=>{
      const sku=b.dataset.sku; const q=CART.get(sku)||0; if(q>1) CART.set(sku,q-1); else CART.delete(sku); saveCart(); updCount(); openCart();
    });
    list.querySelectorAll('.plus').forEach(b=>b.onclick=()=>{
      const sku=b.dataset.sku; CART.set(sku,(CART.get(sku)||0)+1); saveCart(); updCount(); openCart();
    });
  }
  $('#modalCart').classList.add('show');
}

function closeCart(){ $('#modalCart').classList.remove('show'); }

async function router(){
  // —Å–æ–≥–ª–∞—Å–∏–µ 18+
  const accepted = localStorage.getItem(LS_CONSENT) === '1';
  $('#gate').classList.toggle('show', !accepted);

  const h = location.hash || "#/catalog";
  const [_, route, arg] = h.split('/');
  if(route==='product'){ renderProduct(decodeURIComponent(arg||"")); return; }
  if(route==='checkout'){ renderCheckout(); return; }

  // –∫–∞—Ç–∞–ª–æ–≥
  const url = new URL(location.href);
  CAT = url.searchParams.get('cat') || "";
  if(!DATA.length){ await fetchCatalog(); }
  renderCatalog();
}

window.addEventListener('DOMContentLoaded', async ()=>{
  loadCart(); updCount();
  $('#btnCart').onclick = openCart;
  $('#closeCart').onclick = closeCart;
  $('#goCheckout').onclick = ()=>{ location.hash = "#/checkout"; closeCart(); };
  $('#btnBuy').onclick = ()=>{ location.hash = "#/checkout"; };

  // —Å–æ–≥–ª–∞—Å–∏–µ
  $('#gateAccept').onclick = ()=>{
    const ok = $('#ch18').checked && $('#chrules').checked;
    if(!ok){ alert('–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –æ–±–∏–¥–≤–∞ –ø—É–Ω–∫—Ç–∏'); return; }
    localStorage.setItem(LS_CONSENT, '1');
    $('#gate').classList.remove('show');
  };

  await fetchCatalog();
  await router();
});
window.addEventListener('hashchange', router);
</script>
</body>
</html>



















