<!doctype html>
<html lang="uk">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–∞–≥–∞–∑–∏–Ω</title>
<style>
  /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ ¬´–µ—Ö–∞–ª–æ¬ª */
  *,*::before,*::after{box-sizing:border-box}
  body{font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;margin:0 auto;max-width:980px;padding:16px;background:#fafafa;color:#0f172a}
  h2,h3,h4{margin:0 0 10px}
  a{color:inherit}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:8px}
  .actions{display:flex;gap:8px}
  button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer}
  .primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .muted{color:#64748b}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
  .tab{padding:8px 12px;border:1px solid #e5e7eb;border-radius:999px;text-decoration:none}
  .tab.active{background:#111827;border-color:#111827;color:#fff}
  #root{min-height:50vh}

  /* –ö–∞—Ç–∞–ª–æ–≥ */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
  .card img{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;background:#f3f4f6}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .back{display:inline-block;margin:8px 0}

  /* –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è */
  .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .form .full{grid-column:1 / -1}
  input,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}

  /* –ú–æ–¥–∞–ª –∫–æ—Ä–∑–∏–Ω—ã */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
  .modal.show{display:flex}
  .sheet{width:min(92vw,520px);max-height:80vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid #e5e7eb;padding:14px}
  .list{display:grid;gap:8px;margin:8px 0}
  .empty{padding:24px;border:1px dashed #e5e7eb;background:#fff;border-radius:14px;text-align:center;color:#64748b}
</style>
<body>
  <header>
    <h2>üõç –í—ñ—Ç—Ä–∏–Ω–∞</h2>
    <div class="actions">
      <button id="btnCart">üß∫ –ö–æ—à–∏–∫ (<span id="cnt">0</span>)</button>
      <button id="btnCheckout" class="primary">–û—Ñ–æ—Ä–º–∏—Ç–∏</button>
    </div>
  </header>

  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <nav class="tabs" id="tabs">
    <a class="tab" data-cat=""            href="#/catalog">–í—Å—ñ</a>
    <a class="tab" data-cat="devises"     href="#/catalog?cat=devises">–î–µ–≤–∞–π—Å–∏</a>
    <a class="tab" data-cat="liquids"     href="#/catalog?cat=liquids">–†—ñ–¥–∏–Ω–∏</a>
    <a class="tab" data-cat="cartridges"  href="#/catalog?cat=cartridges">–ö–∞—Ä—Ç—Ä–∏–¥–∂—ñ</a>
  </nav>

  <div id="root"></div>

  <!-- –ú–æ–¥–∞–ª –∫–æ—Ä–∑–∏–Ω—ã -->
  <div class="modal" id="cartModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="row">
        <h3>–ö–æ—à–∏–∫</h3>
        <button id="closeCart">‚úï</button>
      </div>
      <div id="cartBody"></div>
      <div class="row" style="margin-top:8px">
        <button id="clearCart" class="muted" style="border-color:#e5e7eb">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button id="goCheckout" class="primary">–î–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</button>
      </div>
    </div>
  </div>

<script>
/* ------------ state & utils ------------ */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = (p,c)=>`${p} ${c||'UAH'}`;
const LS = "tgshop.cart.v1";

let CART = new Map();     // sku -> qty
let DATA = [];            // cache catalog
let CAT  = "";            // current category

function loadCart(){ try{ const raw = localStorage.getItem(LS); if(raw) CART = new Map(JSON.parse(raw)); }catch{} }
function saveCart(){ try{ localStorage.setItem(LS, JSON.stringify([...CART.entries()])); }catch{} }
function cartCount(){ let n=0; for(const q of CART.values()) n+=q; return n; }
function updCount(){ $('#cnt').textContent = cartCount(); }
function inTg(){ try{ return typeof Telegram!=='undefined' && Telegram.WebApp && Telegram.WebApp.sendData; }catch{ return false; }}

/* ------------ data ------------ */
async function fetchCatalog(){
  const r = await fetch('/api/catalog');
  const j = await r.json();
  DATA = (j.items||[]).slice().sort((a,b)=> (a.category||'').localeCompare(b.category||'') || a.title.localeCompare(b.title));
}

/* ------------ renderers ------------ */
function setTabs(cat){
  CAT = cat || "";
  $$('#tabs .tab').forEach(t=> t.classList.toggle('active', (t.dataset.cat||'')===CAT));
}

function renderCatalog(cat=""){
  setTabs(cat);
  const list = DATA.filter(p=> !CAT || (p.category||"")===CAT );
  const root = $('#root');
  if(!list.length){ root.innerHTML = `<div class="empty">–¢—É—Ç –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—å–æ</div>`; return; }

  root.innerHTML = `<div class="grid" id="grid"></div>`;
  const grid = $('#grid');

  list.forEach(p=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" alt="">
      <h4 style="margin:8px 0 4px">${p.title} ${p.availability==='preorder'?'<span class="muted">¬∑ –ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>':''}</h4>
      <div class="muted" style="min-height:38px">${p.description? p.description.slice(0,90):''}</div>
      <div class="row" style="margin-top:6px">
        <b>${fmt(p.price,p.currency)}</b>
        <div>
          <button data-act="add"  data-sku="${p.sku}">–î–æ–¥–∞—Ç–∏</button>
          <button data-act="open" data-sku="${p.sku}" class="primary">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</button>
        </div>
      </div>
    `;
    grid.appendChild(el);
  });

  // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  grid.onclick = (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const sku = b.dataset.sku;
    if(b.dataset.act==='add'){
      CART.set(sku,(CART.get(sku)||0)+1); saveCart(); updCount();
    } else if(b.dataset.act==='open'){
      location.hash = '#/product/'+encodeURIComponent(sku);
    }
  };
}

function renderProduct(sku){
  const p = DATA.find(x=>x.sku===sku);
  const root = $('#root');
  if(!p){ root.innerHTML = `<div class="empty">–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>`; return; }

  root.innerHTML = `
    <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="card">
      <div class="row" style="align-items:flex-start;gap:16px">
        <img src="${p.image_url||'https://via.placeholder.com/800?text=No+Image'}" style="width:320px;max-width:46%;aspect-ratio:1/1;object-fit:cover;border-radius:12px">
        <div style="flex:1">
          <h3 style="margin:0 0 6px">${p.title}</h3>
          <div class="muted" style="margin-bottom:10px">${p.description||''}</div>
          <div class="muted" style="margin-bottom:10px">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <b>${p.category||'‚Äî'}</b></div>
          <div class="muted" style="margin-bottom:14px">–°—Ç–∞—Ç—É—Å: <b>${p.availability==='preorder'?'–ø—Ä–µ–¥–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è':'–≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'}</b></div>
          <div class="row">
            <b style="font-size:18px">${fmt(p.price,p.currency)}</b>
            <div>
              <button id="minus">‚Äì</button>
              <span id="qty" style="display:inline-block;min-width:24px;text-align:center">1</span>
              <button id="plus">+</button>
              <button id="add" class="primary">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;

  let q=1; const $qty = $('#qty');
  $('#minus').onclick = ()=>{ if(q>1){ q--; $qty.textContent=q; } };
  $('#plus').onclick  = ()=>{ q++; $qty.textContent=q; };
  $('#add').onclick   = ()=>{ CART.set(sku,(CART.get(sku)||0)+q); saveCart(); updCount(); alert('–î–æ–¥–∞–Ω–æ'); };
}

function renderCheckout(){
  const items = [...CART.entries()].map(([sku,qty])=>{
    const p = DATA.find(x=>x.sku===sku);
    return {sku,qty,title:p?.title||sku,price:p?.price||0,currency:p?.currency||'UAH'};
  });
  const total = items.reduce((s,i)=> s + i.price*i.qty, 0);
  const root = $('#root');

  root.innerHTML = `
    <a class="back" href="#/catalog${CAT?`?cat=${CAT}`:''}">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="card">
      <h3>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</h3>
      ${items.length?`
        <div class="list">
          ${items.map(i=>`
            <div class="row">
              <div>${i.title} <span class="muted">√ó ${i.qty}</span></div>
              <div><b>${fmt(i.price*i.qty,i.currency)}</b></div>
            </div>`).join('')}
          <div class="row" style="border-top:1px dashed #e5e7eb;padding-top:8px">
            <div><b>–†–∞–∑–æ–º</b></div><div><b>${fmt(total,items[0]?.currency||'UAH')}</b></div>
          </div>
        </div>
      `: `<div class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`}

      <div class="form" style="margin-top:10px">
        <div><label>–ú—ñ—Å—Ç–æ<input id="city" placeholder="–ö–∏—ó–≤"></label></div>
        <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü<input id="branch" placeholder="‚Ññ25"></label></div>
        <div class="full"><label>–ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞<input id="receiver" placeholder="–Ü–º º—è –ü—Ä—ñ–∑–≤–∏—â–µ"></label></div>
        <div><label>–¢–µ–ª–µ—Ñ–æ–Ω<input id="phone" placeholder="+380..."></label></div>
        <div><label>–ù—ñ–∫ —É Telegram (–æ–ø—Ü.)<input id="username" placeholder="@nickname"></label></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="backToCat">‚Üê –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø–æ–∫—É–ø–∫–∏</button>
        <button id="confirm" class="primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>
    </div>
  `;

  $('#backToCat').onclick = ()=>{ location.hash = '#/catalog'+(CAT?`?cat=${CAT}`:''); };

  $('#confirm').onclick = ()=>{
    if(!items.length){ alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return; }
    const city=$('#city').value.trim(),
          branch=$('#branch').value.trim(),
          receiver=$('#receiver').value.trim(),
          phone=$('#phone').value.trim(),
          username=$('#username').value.trim();
    if(!city||!branch||!receiver||!phone){ alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è'); return; }
    const payload = {type:'checkout',items:items.map(i=>({sku:i.sku,qty:i.qty})),
                     city,branch,receiver,phone,username};
    if(inTg()){
      Telegram.WebApp.ready();
      Telegram.WebApp.sendData(JSON.stringify(payload));
      Telegram.WebApp.close();
    } else {
      alert('–í—ñ–¥–∫—Ä–∏–π —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ Telegram, —â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.\n\n'+JSON.stringify(payload,null,2));
    }
  };
}

/* ------------ simple router ------------ */
function parseHash(){
  const h = location.hash || '#/catalog';
  if(h.startsWith('#/catalog')){
    const q = new URLSearchParams(h.split('?')[1]||'');
    return {view:'catalog', cat:(q.get('cat')||'')};
  }
  if(h.startsWith('#/product/')) return {view:'product', sku: decodeURIComponent(h.split('/')[2]||'')};
  if(h==='#/checkout') return {view:'checkout'};
  return {view:'catalog', cat:''};
}

async function render(){
  loadCart(); updCount();
  if(DATA.length===0) await fetchCatalog();
  const r = parseHash();
  if(r.view==='catalog')  renderCatalog(r.cat);
  if(r.view==='product')  renderProduct(r.sku);
  if(r.view==='checkout') renderCheckout();
}

window.addEventListener('hashchange', render);
window.addEventListener('DOMContentLoaded', render);

/* ------------ cart modal ------------ */
function openCart(){
  const items = [...CART.entries()].map(([sku,qty])=>{
    const p = DATA.find(x=>x.sku===sku);
    return {sku,qty,title:p?.title||sku,price:p?.price||0,currency:p?.currency||'UAH'};
  });
  const body = $('#cartBody');
  if(!items.length){
    body.innerHTML = `<div class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`;
  } else {
    body.innerHTML = `
      <div class="list">
        ${items.map(i=>`
          <div class="row">
            <div>${i.title} <span class="muted">√ó ${i.qty}</span></div>
            <div><b>${fmt(i.price*i.qty,i.currency)}</b></div>
          </div>`).join('')}
      </div>
    `;
  }
  $('#cartModal').classList.add('show');
}
$('#btnCart').onclick = openCart;
$('#closeCart').onclick = ()=> $('#cartModal').classList.remove('show');
$('#goCheckout').onclick = ()=>{ $('#cartModal').classList.remove('show'); location.hash = '#/checkout'; };
$('#clearCart').onclick = ()=>{ CART.clear(); saveCart(); updCount(); openCart(); };
$('#cartModal').addEventListener('click', (e)=>{ if(e.target.id==='cartModal') $('#cartModal').classList.remove('show'); });

/* ------------ header actions ------------ */
$('#btnCheckout').onclick = ()=>{ location.hash = '#/checkout'; };
</script>
</body>
</html>














